var et=Object.defineProperty;var tt=(p,n,t)=>n in p?et(p,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):p[n]=t;var m=(p,n,t)=>(tt(p,typeof n!="symbol"?n+"":n,t),t);(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const u of a.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&r(u)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();const x=class x{constructor(n,t,r,s){if(this.x=n,this.y=t,this.z=r,this.key=s,x.instances.has(s))throw Error("duplicate v3i being created")}static create(n,t,r){n=n|0,t=t|0,r=r|0;const s=`${n},${t},${r}`;return this.instances.has(s)||this.instances.set(s,new x(n,t,r,s)),this.instances.get(s)}static add(n,t){return x.create(n.x+t.x,n.y+t.y,n.z+t.z)}static sub(n,t){return x.create(n.x-t.x,n.y-t.y,n.z-t.z)}};m(x,"instances",new Map),m(x,"zero",x.create(0,0,0)),m(x,"up",x.create(0,0,1)),m(x,"down",x.create(0,0,-1)),m(x,"forward",x.create(0,-1,0)),m(x,"back",x.create(0,1,0)),m(x,"right",x.create(1,0,0)),m(x,"left",x.create(-1,0,0));let L=x;const C=class C{constructor(n,t,r){this.x=n,this.y=t,this.z=r}static create(n,t,r){return new C(n,t,r)}static add(n,t){return C.create(n.x+t.x,n.y+t.y,n.z+t.z)}static sub(n,t){return C.create(n.x-t.x,n.y-t.y,n.z-t.z)}static mul(n,t){return C.create(n.x*t,n.y*t,n.z*t)}};m(C,"zero",C.create(0,0,0)),m(C,"up",C.create(0,0,1)),m(C,"down",C.create(0,0,-1)),m(C,"forward",C.create(0,-1,0)),m(C,"back",C.create(0,1,0)),m(C,"right",C.create(1,0,0)),m(C,"left",C.create(-1,0,0));let T=C;const nt={NE:"SE",SE:"SW",SW:"NW",NW:"NE"},E={BLOCK_1:"BLOCK_1",BLOCK_2:"BLOCK_2",BLOCK_3:"BLOCK_3",MIRROR_SE:"MIRROR_SE",MIRROR_SW:"MIRROR_SW",MIRROR_NE:"MIRROR_NE",MIRROW_NW:"MIRROR_NW",WIZARD:"WIZARD",PULSE:"PULSE",EXIT:"EXIT",BOX:"BOX",FONT:"FONT"},ye={LOOP:"LOOP",ONCE:"ONCE",PINGPONG_FORWARD:"PINGPONG_FORWARD",PINGPONG_BACKWARD:"PINGPONG_BACKWARD"},W=class W{constructor(n=!0){m(this,"id");m(this,"type",E.BLOCK_1);m(this,"pos",L.zero);m(this,"lastPos",L.zero);m(this,"screenPos",T.create(0,0,0));m(this,"playbackMode",ye.LOOP);m(this,"frames",[]);m(this,"pickerFrames",[]);m(this,"frameIndex",0);m(this,"frameElapsed",0);m(this,"frameDuration",0);m(this,"age",0);m(this,"momentum",L.zero);m(this,"destroyed",!1);n?(this.id=W.nextId++,W.byId.set(this.id,this)):this.id=-1}static deleteEntity(n){this.byId.delete(n.id)}static clear(){this.byId.clear()}serialize(){return{type:this.type,pos:[this.pos.x,this.pos.y,this.pos.z]}}copy(){const n=new W(!1);return Object.assign(n,this),n}isActor(){return this.type==="WIZARD"||this.type==="MIRROR_NE"||this.type==="MIRROR_SE"||this.type==="MIRROR_NW"||this.type==="MIRROR_SW"||this.type==="BOX"||this.type==="PULSE"}isAffectedByGravity(){return this.type==="WIZARD"||this.type==="MIRROR_NE"||this.type==="MIRROR_SE"||this.type==="MIRROR_NW"||this.type==="MIRROR_SW"||this.type==="BOX"}hasOrientation(){return this.type==="MIRROR_NE"||this.type==="MIRROR_SE"||this.type==="MIRROR_NW"||this.type==="MIRROR_SW"}rotate(){const[n,t]=this.type.split("_");this.type=n+"_"+nt[t];const{frames:r,duration:s,mode:a}=Fe(this);this.frames=r,this.frameDuration=s||0,this.frameElapsed=0,this.frameIndex=0,this.playbackMode=a,me(this)}};m(W,"nextId",1),m(W,"byId",new Map);let K=W;const ne=2,R=3,rt=32,Me=rt*R,ie=Me/2,Q=Me/4,be=.5,ot=500,st=16;function it(p,n,t){const r=[];for(let s=0;s<n;s++){const a=[];r.push(a);for(let u=0;u<p;u++)a.push(t)}return r}function at(p){const n=p&255,t=p>>8&255,r=p>>16&255;return[n,t,r,0]}function pt(p,n,t,r){return p|n<<8|t<<16}function U(p,n,t){const r=n.y-p.y,s=t.x-p.x,a=t.y-p.y;return T.create(r-a+p.y,s+p.x,t.z)}function Be(p,n,t,r){switch(r){case 0:return t;case 1:return U(p,n,t);case 2:return U(p,n,U(p,n,t));case 3:return U(p,n,U(p,n,U(p,n,t)));default:return t}}const lt={WIZARD:"wiz",BLOCK_1:"block-1",BLOCK_2:"block-2",BLOCK_3:"block-3",MIRROR_NE:"mirror-ne",MIRROR_NW:"mirror-nw",MIRROR_SW:"mirror-sw",MIRROR_SE:"mirror-se",EXIT:"exit",BOX:"box",PULSE:"pulse"},_e={wiz:{name:"wiz",rect:{x:0,y:0,w:32,h:32},frames:16,speed:96},"block-1":{name:"block-1",rect:{x:0,y:32,w:32,h:32},frames:1},"block-2":{name:"block-2",rect:{x:0,y:32,w:32,h:32},frames:1},"block-3":{name:"block-3",rect:{x:0,y:32,w:32,h:32},frames:1},"block-highlight":{name:"block-highlight",rect:{x:32*15,y:32,w:32,h:32},frames:1},block:{name:"block",rect:{x:0,y:32,w:32,h:32},frames:3},"block-frame":{name:"block-frame",rect:{x:32*14,y:32,w:32,h:32},frames:1},dot:{name:"dot",rect:{x:64,y:64,w:32,h:16},frames:2},highlight:{name:"highlight",rect:{x:128,y:64,w:32,h:16},frames:1},eraser:{name:"eraser",rect:{x:160,y:64,w:32,h:16},frames:1},"rotate-right":{name:"rotate-right",rect:{x:192,y:64,w:32,h:16},frames:1},"rotate-left":{name:"rotate-left",rect:{x:224,y:64,w:32,h:16},frames:1},play:{name:"play",rect:{x:256,y:64,w:32,h:16},frames:1},save:{name:"save",rect:{x:288,y:64,w:32,h:16},frames:1},folder:{name:"folder",rect:{x:320,y:64,w:32,h:16},frames:1},copy:{name:"copy",rect:{x:352,y:64,w:32,h:16},frames:1},undo:{name:"undo",rect:{x:384,y:64,w:32,h:16},frames:1},redo:{name:"redo",rect:{x:416,y:64,w:32,h:16},frames:1},plus:{name:"plus",rect:{x:448,y:64,w:32,h:16},frames:1},"mirror-se":{name:"mirror-se",rect:{x:0,y:80,w:32,h:32},frames:12,speed:128},"mirror-sw":{name:"mirror-sw",rect:{x:0,y:112,w:32,h:32},frames:12,speed:128},"mirror-nw":{name:"mirror-nw",rect:{x:0,y:144,w:32,h:32},frames:1},"mirror-ne":{name:"mirror-ne",rect:{x:32,y:144,w:32,h:32},frames:1},box:{name:"box",rect:{x:64,y:64*2+16,w:32,h:32},frames:1},exit:{name:"exit",rect:{x:0,y:64+32*3+16,w:32,h:32},frames:6,speed:192},"font-1":{name:"font-1",rect:{x:0,y:64+32*4+16,w:32,h:32},frames:16},"font-2":{name:"font-2",rect:{x:0,y:64+32*5+16,w:32,h:32},frames:16},"font-3":{name:"font-3",rect:{x:0,y:64+32*6+16,w:32,h:32},frames:16},"font-4":{name:"font-4",rect:{x:0,y:64+32*8+16,w:16,h:16},frames:32},"font-5":{name:"font-5",rect:{x:0,y:64+32*8+16*2,w:16,h:16},frames:15},pulse:{name:"pulse",rect:{x:0,y:64+32*8+16*3,w:32,h:32},frames:8,speed:32},burst:{name:"burst",rect:{x:0,y:64+32*9+16*3,w:32,h:32},frames:16,speed:24,mode:ye.ONCE}},oe={},A={},De=new Map;function ut(p){const n=document.createElement("img");n.onload=()=>{dt(n),_t(),p()},n.src="assets/spritesheet.png"}function ct(p){const t=p.getContext("2d").getImageData(0,0,p.width,p.height),r=it(p.width,p.height,!1);for(let s=0;s<t.height;s++)for(let a=0;a<t.width;a++){const u=s*(t.width*4)+a*4+3,y=t.data[u];r[s][a]=y===255}return r}function _t(){const p="abcdefghijklmnop",n="qrstuvwxyz012345",t=`6789?!,'." :)(;`,r=p+n,s=t,a=[p,n,t];for(let y=0;y<a.length;y++){const h="font-"+(y+1),_=a[y];for(let v=0;v<_.length;v++)_[v],A[h][v]}const u=[r,s];for(let y=0;y<u.length;y++){const h="font-"+(y+4),_=u[y];for(let v=0;v<_.length;v++){const e=_[v];oe[e]=A[h][v]}}}function dt(p){for(const n of Object.values(_e)){const t=[];A[n.name]=t;for(let r=0;r<n.frames;r++){const s=document.createElement("canvas");t.push(s),s.width=n.rect.w,s.height=n.rect.h,s.getContext("2d").drawImage(p,n.rect.x+r*n.rect.w,n.rect.y,n.rect.w,n.rect.h,0,0,n.rect.w,n.rect.h),De.set(s,ct(s))}}}function me(p){const{id:n,frames:t}=p,r=at(n),s=[];p.pickerFrames=s;for(const a of t){const u=De.get(a),y=document.createElement("canvas");s.push(y),y.width=a.width,y.height=a.height;const h=y.getContext("2d",{willReadFrequently:!0}),_=h.createImageData(y.width,y.height);for(let v=0;v<y.height;v++)for(let e=0;e<y.width;e++){if(!u[v][e])continue;const o=v*(y.width*4)+e*4;_.data[o]=r[0],_.data[o+1]=r[1],_.data[o+2]=r[2],_.data[o+3]=255}h.putImageData(_,0,0)}}function Fe(p){let n=lt[p.type];p.destroyed&&(n="burst"),console.log(_e[n]);const{name:t,speed:r,mode:s}=_e[n],a=A[n];return{name:t,frames:a,duration:r,mode:s||"LOOP"}}class ft{constructor(){m(this,"then");m(this,"dt");m(this,"isRunning");m(this,"canvas");m(this,"screens",[]);m(this,"resize",()=>{this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight});this.then=new Date().getTime(),this.dt=0,this.isRunning=!1,this.canvas=document.createElement("canvas"),this.canvas.tabIndex=1,document.body.appendChild(this.canvas),window.addEventListener("resize",this.resize),this.resize()}pushScreen(n){this.screens.push(n)}popScreen(){var n;(n=this.screens.pop())==null||n.onExit()}start(){if(this.isRunning)return;this.isRunning=!0;const n=()=>{if(!this.isRunning)return;const t=new Date().getTime();this.dt=t-this.then,this.then=t,this.screens[this.screens.length-1].tick(),requestAnimationFrame(n)};requestAnimationFrame(n)}stop(){this.isRunning=!1}}const V=document.createElement("canvas");function Ne(p,n,t,r,s){V.width=p.width,V.height=p.height;const a=V.getContext("2d",{willReadFrequently:!0});a.clearRect(0,0,V.width,V.height),ve(V,n,t,{x:r,y:s});const u=a.getImageData(r,s,1,1);return pt(u.data[0],u.data[1],u.data[2],u.data[3])}function ve(p,n,t,r){t.sort((a,u)=>{const y=a.screenPos.x+a.screenPos.y+a.screenPos.z,h=a.screenPos.x+u.screenPos.y+u.screenPos.z;return y<h?-1:h<y?1:0});let s;if(r){const a=r.x,u=r.y;s=(y,h,_,v)=>!(a<y||a>y+_||u<h||u>h+v)}ht(p,n,t,s)}function ht(p,n,t,r){const s=p.getContext("2d");for(const a of t){const u=r!=null?a.pickerFrames[a.frameIndex]:a.frames[a.frameIndex],y=n.x,h=n.y,_=a.screenPos.x*ie-a.screenPos.y*ie;let v=a.screenPos.x*Q+a.screenPos.y*Q;v-=a.screenPos.z*Q*2,s.imageSmoothingEnabled=!1,s.drawImage(u,0,0,u.width,u.height,y+_,h+v,u.width*R,u.height*R)}}function He(p,n,t,r){yt(p,n,t.screenPos,r)}function yt(p,n,t,r){const s=p.getContext("2d"),a=n.x,u=n.y,y=t.x*ie-t.y*ie;let h=t.x*Q+t.y*Q;h-=t.z*Q*2,s.imageSmoothingEnabled=!1,s.drawImage(r,0,0,r.width,r.height,a+y,u+h,r.width*R,r.height*R)}function mt(p,n,t,r){const s=p.getContext("2d");s.imageSmoothingEnabled=!1,s.drawImage(n,0,0,n.width,n.height,t,r,n.width*R,n.height*R)}const ce=2147483647;class G{constructor(){m(this,"name","New Puzzle");m(this,"next","");m(this,"hint","");m(this,"v2e",new Map);m(this,"player");m(this,"actors",new Set);m(this,"history",[]);m(this,"initialState",[]);m(this,"id");m(this,"isDirty",!1);this.id=(Math.random()*ce|0).toString(16)+":"+(Math.random()*ce|0).toString(16)+":"+(Math.random()*ce|0).toString(16)}init(){this.history.length,this.actors.size;for(const n of this.v2e.values())n.isActor()&&this.actors.add(n),n.type==="WIZARD"&&(this.player=n);this.initialState=[...this.v2e.values()].map(n=>n.copy())}deleteEntity(n){if(!this.v2e.has(n))return;this.isDirty=!0;const t=this.v2e.get(n);this.v2e.delete(n),this.actors.delete(t),K.deleteEntity(t)}createEntity(n,t){this.deleteEntity(t),this.isDirty=!0;const r=new K;r.type=n,r.pos=t,r.lastPos=r.pos,r.screenPos=T.create(t.x,t.y,t.z);const{frames:s,duration:a}=Fe(r);return r.frames=s,r.frameDuration=a||0,this.v2e.set(r.pos,r),r.type==E.WIZARD&&(this.player=r),r.isActor()&&this.actors.add(r),me(r),r}getBounds(){const n=T.create(1/0,1/0,1/0),t=T.create(-1/0,-1/0,-1/0);for(const r of this.v2e.keys())n.x=Math.min(r.x,n.x),n.y=Math.min(r.y,n.y),n.z=Math.min(r.z,n.z),t.x=Math.max(r.x,t.x),t.y=Math.max(r.y,t.y),t.z=Math.max(r.z,t.z);return{min:n,max:t}}rotateLeft(n=!0){this.pushHistoryAll(),this._rotate(n),this._rotate(n),this._rotate(n)}rotateRight(n=!0){this.pushHistoryAll(),this._rotate(n)}_rotate(n=!0){const{min:t,max:r}=this.getBounds(),s=new Map;for(const a of this.v2e.values()){const u=Be(t,r,a.pos,1);a.lastPos=a.pos,a.pos=L.create(u.x,u.y,u.z),n&&(a.screenPos=Be(t,r,a.screenPos,1)),s.set(a.pos,a),a.hasOrientation()&&a.rotate()}this.v2e=s}getEntityAbove(n){return this.v2e.get(L.add(n,L.up))||null}getEntityBelow(n){return this.v2e.get(L.add(n,L.down))||null}canMoveActor(n,t){if(!n.isActor())return!1;const r=this.v2e.get(L.add(n.pos,t));return r==null?!0:r.isActor()?this.canMoveActor(r,t):!1}moveActor(n,t){if(t==L.zero)return;const r=this.v2e.get(L.add(n.pos,t));if(r!=null&&this.moveActor(r,t),this.v2e.delete(n.pos),n.lastPos=n.pos,n.pos=L.add(n.pos,t),this.v2e.set(n.pos,n),t!==L.up){const s=this.getEntityAbove(n.lastPos);s&&this.canMoveActor(s,t)&&this.moveActor(s,t)}}applyGravity(n){return n.isAffectedByGravity()&&this.v2e.get(L.add(n.pos,L.down))==null&&n.pos.z>0?(this.moveActor(n,L.down),!0):!1}didPlayerWin(){const n=this.getEntityBelow(this.player.pos);return n!==null&&n.type===E.EXIT}didPlayerLose(){return this.player.pos.z<=0}isGameOver(){return this.didPlayerWin()||this.didPlayerLose()}pushHistory(){this.history.push([...this.actors].map(n=>n.copy()))}pushHistoryAll(){this.history.push([...this.v2e.values()].map(n=>n.copy()))}movePlayer(n){const t=this.player;this.canMoveActor(t,n)&&(this.pushHistory(),this.moveActor(t,n))}tick(){let n=!1;for(const t of this.actors){if(t.destroyed||t.momentum===L.zero)continue;t.age++,n=!0;const r=L.add(t.pos,t.momentum),s=this.v2e.get(r);s==null?this.moveActor(t,t.momentum):(!s.isActor()||!this.canMoveActor(s,t.momentum)||this.moveActor(t,t.momentum),t.destroyed=!0)}for(const t of this.actors)t.type===E.PULSE&&t.age>=st&&(t.destroyed=!0);for(const t of this.actors)n=n||this.applyGravity(t);return n}undo(){const n=this.history[this.history.length-1];for(const t of n)this.v2e.delete(K.byId.get(t.id).pos);for(const t of n){const r=K.byId.get(t.id);Object.assign(r,t),this.v2e.set(r.pos,r)}this.history.length>1&&this.history.pop()}reset(){this.history.push(this.initialState),this.undo()}serialize(){return{name:this.name,next:this.next,id:this.id,hint:this.hint,entities:[...this.v2e.values()].map(n=>n.serialize())}}static deserialize(n){const t=new G;t.id=n.id,t.name=n.name,t.next=n.next,t.hint=n.hint;for(const r of n.entities){const s=L.create(r.pos[0],r.pos[1],r.pos[2]);t.createEntity(r.type,s)}return t.init(),t}}var pe,B,We,H,xe,Xe,de,te={},Ge=[],vt=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,ge=Array.isArray;function z(p,n){for(var t in n)p[t]=n[t];return p}function $e(p){var n=p.parentNode;n&&n.removeChild(p)}function Ze(p,n,t){var r,s,a,u={};for(a in n)a=="key"?r=n[a]:a=="ref"?s=n[a]:u[a]=n[a];if(arguments.length>2&&(u.children=arguments.length>3?pe.call(arguments,2):t),typeof p=="function"&&p.defaultProps!=null)for(a in p.defaultProps)u[a]===void 0&&(u[a]=p.defaultProps[a]);return se(p,u,r,s,null)}function se(p,n,t,r,s){var a={type:p,props:n,key:t,ref:r,__k:null,__:null,__b:0,__e:null,__d:void 0,__c:null,constructor:void 0,__v:s??++We,__i:-1,__u:0};return s==null&&B.vnode!=null&&B.vnode(a),a}function gt(){return{current:null}}function le(p){return p.children}function ee(p,n){this.props=p,this.context=n}function Y(p,n){if(n==null)return p.__?Y(p.__,p.__i+1):null;for(var t;n<p.__k.length;n++)if((t=p.__k[n])!=null&&t.__e!=null)return t.__e;return typeof p.type=="function"?Y(p):null}function Ue(p){var n,t;if((p=p.__)!=null&&p.__c!=null){for(p.__e=p.__c.base=null,n=0;n<p.__k.length;n++)if((t=p.__k[n])!=null&&t.__e!=null){p.__e=p.__c.base=t.__e;break}return Ue(p)}}function Ce(p){(!p.__d&&(p.__d=!0)&&H.push(p)&&!ae.__r++||xe!==B.debounceRendering)&&((xe=B.debounceRendering)||Xe)(ae)}function ae(){var p,n,t,r,s,a,u,y,h;for(H.sort(de);p=H.shift();)p.__d&&(n=H.length,r=void 0,a=(s=(t=p).__v).__e,y=[],h=[],(u=t.__P)&&((r=z({},s)).__v=s.__v+1,B.vnode&&B.vnode(r),Oe(u,r,s,t.__n,u.ownerSVGElement!==void 0,32&s.__u?[a]:null,y,a??Y(s),!!(32&s.__u),h),r.__.__k[r.__i]=r,Ye(y,r,h),r.__e!=a&&Ue(r)),H.length>n&&H.sort(de));ae.__r=0}function Ve(p,n,t,r,s,a,u,y,h,_,v){var e,o,i,l,d,f=r&&r.__k||Ge,c=n.length;for(t.__d=h,Ot(t,n,f),h=t.__d,e=0;e<c;e++)(i=t.__k[e])!=null&&typeof i!="boolean"&&typeof i!="function"&&(o=i.__i===-1?te:f[i.__i]||te,i.__i=e,Oe(p,i,o,s,a,u,y,h,_,v),l=i.__e,i.ref&&o.ref!=i.ref&&(o.ref&&we(o.ref,null,i),v.push(i.ref,i.__c||l,i)),d==null&&l!=null&&(d=l),65536&i.__u||o.__k===i.__k?h=Qe(i,h,p):typeof i.type=="function"&&i.__d!==void 0?h=i.__d:l&&(h=l.nextSibling),i.__d=void 0,i.__u&=-196609);t.__d=h,t.__e=d}function Ot(p,n,t){var r,s,a,u,y,h=n.length,_=t.length,v=_,e=0;for(p.__k=[],r=0;r<h;r++)(s=p.__k[r]=(s=n[r])==null||typeof s=="boolean"||typeof s=="function"?null:typeof s=="string"||typeof s=="number"||typeof s=="bigint"||s.constructor==String?se(null,s,null,null,s):ge(s)?se(le,{children:s},null,null,null):s.__b>0?se(s.type,s.props,s.key,s.ref?s.ref:null,s.__v):s)!=null?(s.__=p,s.__b=p.__b+1,y=wt(s,t,u=r+e,v),s.__i=y,a=null,y!==-1&&(v--,(a=t[y])&&(a.__u|=131072)),a==null||a.__v===null?(y==-1&&e--,typeof s.type!="function"&&(s.__u|=65536)):y!==u&&(y===u+1?e++:y>u?v>h-u?e+=y-u:e--:e=y<u&&y==u-1?y-u:0,y!==r+e&&(s.__u|=65536))):(a=t[r])&&a.key==null&&a.__e&&(a.__e==p.__d&&(p.__d=Y(a)),fe(a,a,!1),t[r]=null,v--);if(v)for(r=0;r<_;r++)(a=t[r])!=null&&!(131072&a.__u)&&(a.__e==p.__d&&(p.__d=Y(a)),fe(a,a))}function Qe(p,n,t){var r,s;if(typeof p.type=="function"){for(r=p.__k,s=0;r&&s<r.length;s++)r[s]&&(r[s].__=p,n=Qe(r[s],n,t));return n}return p.__e!=n&&(t.insertBefore(p.__e,n||null),n=p.__e),n&&n.nextSibling}function wt(p,n,t,r){var s=p.key,a=p.type,u=t-1,y=t+1,h=n[t];if(h===null||h&&s==h.key&&a===h.type)return t;if(r>(h!=null&&!(131072&h.__u)?1:0))for(;u>=0||y<n.length;){if(u>=0){if((h=n[u])&&!(131072&h.__u)&&s==h.key&&a===h.type)return u;u--}if(y<n.length){if((h=n[y])&&!(131072&h.__u)&&s==h.key&&a===h.type)return y;y++}}return-1}function Te(p,n,t){n[0]==="-"?p.setProperty(n,t??""):p[n]=t==null?"":typeof t!="number"||vt.test(n)?t:t+"px"}function re(p,n,t,r,s){var a;e:if(n==="style")if(typeof t=="string")p.style.cssText=t;else{if(typeof r=="string"&&(p.style.cssText=r=""),r)for(n in r)t&&n in t||Te(p.style,n,"");if(t)for(n in t)r&&t[n]===r[n]||Te(p.style,n,t[n])}else if(n[0]==="o"&&n[1]==="n")a=n!==(n=n.replace(/(PointerCapture)$|Capture$/,"$1")),n=n.toLowerCase()in p?n.toLowerCase().slice(2):n.slice(2),p.l||(p.l={}),p.l[n+a]=t,t?r?t.u=r.u:(t.u=Date.now(),p.addEventListener(n,a?Pe:Ie,a)):p.removeEventListener(n,a?Pe:Ie,a);else{if(s)n=n.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if(n!=="width"&&n!=="height"&&n!=="href"&&n!=="list"&&n!=="form"&&n!=="tabIndex"&&n!=="download"&&n!=="rowSpan"&&n!=="colSpan"&&n!=="role"&&n in p)try{p[n]=t??"";break e}catch{}typeof t=="function"||(t==null||t===!1&&n[4]!=="-"?p.removeAttribute(n):p.setAttribute(n,t))}}function Ie(p){var n=this.l[p.type+!1];if(p.t){if(p.t<=n.u)return}else p.t=Date.now();return n(B.event?B.event(p):p)}function Pe(p){return this.l[p.type+!0](B.event?B.event(p):p)}function Oe(p,n,t,r,s,a,u,y,h,_){var v,e,o,i,l,d,f,c,g,O,b,P,k,S,D,w=n.type;if(n.constructor!==void 0)return null;128&t.__u&&(h=!!(32&t.__u),a=[y=n.__e=t.__e]),(v=B.__b)&&v(n);e:if(typeof w=="function")try{if(c=n.props,g=(v=w.contextType)&&r[v.__c],O=v?g?g.props.value:v.__:r,t.__c?f=(e=n.__c=t.__c).__=e.__E:("prototype"in w&&w.prototype.render?n.__c=e=new w(c,O):(n.__c=e=new ee(c,O),e.constructor=w,e.render=At),g&&g.sub(e),e.props=c,e.state||(e.state={}),e.context=O,e.__n=r,o=e.__d=!0,e.__h=[],e._sb=[]),e.__s==null&&(e.__s=e.state),w.getDerivedStateFromProps!=null&&(e.__s==e.state&&(e.__s=z({},e.__s)),z(e.__s,w.getDerivedStateFromProps(c,e.__s))),i=e.props,l=e.state,e.__v=n,o)w.getDerivedStateFromProps==null&&e.componentWillMount!=null&&e.componentWillMount(),e.componentDidMount!=null&&e.__h.push(e.componentDidMount);else{if(w.getDerivedStateFromProps==null&&c!==i&&e.componentWillReceiveProps!=null&&e.componentWillReceiveProps(c,O),!e.__e&&(e.shouldComponentUpdate!=null&&e.shouldComponentUpdate(c,e.__s,O)===!1||n.__v===t.__v)){for(n.__v!==t.__v&&(e.props=c,e.state=e.__s,e.__d=!1),n.__e=t.__e,n.__k=t.__k,n.__k.forEach(function(F){F&&(F.__=n)}),b=0;b<e._sb.length;b++)e.__h.push(e._sb[b]);e._sb=[],e.__h.length&&u.push(e);break e}e.componentWillUpdate!=null&&e.componentWillUpdate(c,e.__s,O),e.componentDidUpdate!=null&&e.__h.push(function(){e.componentDidUpdate(i,l,d)})}if(e.context=O,e.props=c,e.__P=p,e.__e=!1,P=B.__r,k=0,"prototype"in w&&w.prototype.render){for(e.state=e.__s,e.__d=!1,P&&P(n),v=e.render(e.props,e.state,e.context),S=0;S<e._sb.length;S++)e.__h.push(e._sb[S]);e._sb=[]}else do e.__d=!1,P&&P(n),v=e.render(e.props,e.state,e.context),e.state=e.__s;while(e.__d&&++k<25);e.state=e.__s,e.getChildContext!=null&&(r=z(z({},r),e.getChildContext())),o||e.getSnapshotBeforeUpdate==null||(d=e.getSnapshotBeforeUpdate(i,l)),Ve(p,ge(D=v!=null&&v.type===le&&v.key==null?v.props.children:v)?D:[D],n,t,r,s,a,u,y,h,_),e.base=n.__e,n.__u&=-161,e.__h.length&&u.push(e),f&&(e.__E=e.__=null)}catch(F){n.__v=null,h||a!=null?(n.__e=y,n.__u|=h?160:32,a[a.indexOf(y)]=null):(n.__e=t.__e,n.__k=t.__k),B.__e(F,n,t)}else a==null&&n.__v===t.__v?(n.__k=t.__k,n.__e=t.__e):n.__e=Lt(t.__e,n,t,r,s,a,u,h,_);(v=B.diffed)&&v(n)}function Ye(p,n,t){n.__d=void 0;for(var r=0;r<t.length;r++)we(t[r],t[++r],t[++r]);B.__c&&B.__c(n,p),p.some(function(s){try{p=s.__h,s.__h=[],p.some(function(a){a.call(s)})}catch(a){B.__e(a,s.__v)}})}function Lt(p,n,t,r,s,a,u,y,h){var _,v,e,o,i,l,d,f=t.props,c=n.props,g=n.type;if(g==="svg"&&(s=!0),a!=null){for(_=0;_<a.length;_++)if((i=a[_])&&"setAttribute"in i==!!g&&(g?i.localName===g:i.nodeType===3)){p=i,a[_]=null;break}}if(p==null){if(g===null)return document.createTextNode(c);p=s?document.createElementNS("http://www.w3.org/2000/svg",g):document.createElement(g,c.is&&c),a=null,y=!1}if(g===null)f===c||y&&p.data===c||(p.data=c);else{if(a=a&&pe.call(p.childNodes),f=t.props||te,!y&&a!=null)for(f={},_=0;_<p.attributes.length;_++)f[(i=p.attributes[_]).name]=i.value;for(_ in f)i=f[_],_=="children"||(_=="dangerouslySetInnerHTML"?e=i:_==="key"||_ in c||re(p,_,null,i,s));for(_ in c)i=c[_],_=="children"?o=i:_=="dangerouslySetInnerHTML"?v=i:_=="value"?l=i:_=="checked"?d=i:_==="key"||y&&typeof i!="function"||f[_]===i||re(p,_,i,f[_],s);if(v)y||e&&(v.__html===e.__html||v.__html===p.innerHTML)||(p.innerHTML=v.__html),n.__k=[];else if(e&&(p.innerHTML=""),Ve(p,ge(o)?o:[o],n,t,r,s&&g!=="foreignObject",a,u,a?a[0]:t.__k&&Y(t,0),y,h),a!=null)for(_=a.length;_--;)a[_]!=null&&$e(a[_]);y||(_="value",l!==void 0&&(l!==p[_]||g==="progress"&&!l||g==="option"&&l!==f[_])&&re(p,_,l,f[_],!1),_="checked",d!==void 0&&d!==p[_]&&re(p,_,d,f[_],!1))}return p}function we(p,n,t){try{typeof p=="function"?p(n):p.current=n}catch(r){B.__e(r,t)}}function fe(p,n,t){var r,s;if(B.unmount&&B.unmount(p),(r=p.ref)&&(r.current&&r.current!==p.__e||we(r,null,n)),(r=p.__c)!=null){if(r.componentWillUnmount)try{r.componentWillUnmount()}catch(a){B.__e(a,n)}r.base=r.__P=null,p.__c=void 0}if(r=p.__k)for(s=0;s<r.length;s++)r[s]&&fe(r[s],n,t||typeof p.type!="function");t||p.__e==null||$e(p.__e),p.__=p.__e=p.__d=void 0}function At(p,n,t){return this.constructor(p,t)}function Ee(p,n,t){var r,s,a,u;B.__&&B.__(p,n),s=(r=typeof t=="function")?null:t&&t.__k||n.__k,a=[],u=[],Oe(n,p=(!r&&t||n).__k=Ze(le,null,[p]),s||te,te,n.ownerSVGElement!==void 0,!r&&t?[t]:s?null:n.firstChild?pe.call(n.childNodes):null,a,!r&&t?t:s?s.__e:n.firstChild,r,u),Ye(a,p,u)}pe=Ge.slice,B={__e:function(p,n,t,r){for(var s,a,u;n=n.__;)if((s=n.__c)&&!s.__)try{if((a=s.constructor)&&a.getDerivedStateFromError!=null&&(s.setState(a.getDerivedStateFromError(p)),u=s.__d),s.componentDidCatch!=null&&(s.componentDidCatch(p,r||{}),u=s.__d),u)return s.__E=s}catch(y){p=y}throw p}},We=0,ee.prototype.setState=function(p,n){var t;t=this.__s!=null&&this.__s!==this.state?this.__s:this.__s=z({},this.state),typeof p=="function"&&(p=p(z({},t),this.props)),p&&z(t,p),p!=null&&this.__v&&(n&&this._sb.push(n),Ce(this))},ee.prototype.forceUpdate=function(p){this.__v&&(this.__e=!0,p&&this.__h.push(p),Ce(this))},ee.prototype.render=le,H=[],Xe=typeof Promise=="function"?Promise.prototype.then.bind(Promise.resolve()):setTimeout,de=function(p,n){return p.__v.__b-n.__v.__b},ae.__r=0;var qe=function(p,n,t,r){var s;n[0]=0;for(var a=1;a<n.length;a++){var u=n[a++],y=n[a]?(n[0]|=u?1:2,t[n[a++]]):n[++a];u===3?r[0]=y:u===4?r[1]=Object.assign(r[1]||{},y):u===5?(r[1]=r[1]||{})[n[++a]]=y:u===6?r[1][n[++a]]+=y+"":u?(s=p.apply(y,qe(p,y,t,["",null])),r.push(s),y[0]?n[0]|=2:(n[a-2]=0,n[a]=s)):r.push(y)}return r},Ke=new Map;function bt(p){var n=Ke.get(this);return n||(n=new Map,Ke.set(this,n)),(n=qe(this,n.get(p)||(n.set(p,n=function(t){for(var r,s,a=1,u="",y="",h=[0],_=function(o){a===1&&(o||(u=u.replace(/^\s*\n\s*|\s*\n\s*$/g,"")))?h.push(0,o,u):a===3&&(o||u)?(h.push(3,o,u),a=2):a===2&&u==="..."&&o?h.push(4,o,0):a===2&&u&&!o?h.push(5,0,!0,u):a>=5&&((u||!o&&a===5)&&(h.push(a,0,u,s),a=6),o&&(h.push(a,o,0,s),a=6)),u=""},v=0;v<t.length;v++){v&&(a===1&&_(),_(v));for(var e=0;e<t[v].length;e++)r=t[v][e],a===1?r==="<"?(_(),h=[h],a=3):u+=r:a===4?u==="--"&&r===">"?(a=1,u=""):u=r+u[0]:y?r===y?y="":u+=r:r==='"'||r==="'"?y=r:r===">"?(_(),a=1):a&&(r==="="?(a=5,s=u,u=""):r==="/"&&(a<5||t[v][e+1]===">")?(_(),a===3&&(h=h[0]),a=h,(h=h[0]).push(2,0,a),a=0):r===" "||r==="	"||r===`
`||r==="\r"?(_(),a=2):u+=r),a===3&&u==="!--"&&(a=4,h=h[0])}return _(),h}(p)),n),arguments,[])).length>1?n:n[0]}const $=bt.bind(Ze);class ke extends ee{constructor(){super();m(this,"canvasRef");m(this,"swallowEvent",t=>{t.stopPropagation()});this.canvasRef=gt()}componentDidMount(){const{brushData:t}=this.props,r=this.canvasRef.current;if(r==null)return;r.width=t.sprite.width*ne,r.height=t.sprite.height*ne;const s=r.getContext("2d");s.imageSmoothingEnabled=!1,s.drawImage(t.sprite,0,0,t.sprite.width,t.sprite.height,0,0,t.sprite.width*ne,t.sprite.height*ne)}render(){const{brushData:t,activeBrush:r,handleClick:s}=this.props,a=y=>{y.stopPropagation(),s(this.props.brushData)};return $`
            <canvas 
                class="${t===r?"PaletteButton selected":"PaletteButton"}" 
                ref=${this.canvasRef} 
                onClick=${a}
                onMouseDown=${this.swallowEvent}
            >
            </canvas>
        `}}function Se(p){const{className:n,brushes:t,handleClick:r,activeBrush:s}=p,a=t.map(u=>$`
        <${ke}
            brushData=${u}
            activeBrush=${s}
            handleClick=${r}
        >
        </${ke}>
    `);return $`
    <div class="${n}">
        ${a}
    </div>
    `}function Bt(p){const{puzzles:n}=p,t=n.map(r=>$`
            <div className="FolderEntry" onClick=${()=>p.handleClick(r.id)}>
                ${r.name}
            </div>
        `);return $`
        <div className="Folder">
            ${t}
        </div>
    `}function xt(p){const{puzzle:n}=p,t=a=>{n.name=a.target.value},r=a=>{n.next=a.target.value},s=a=>{n.hint=a.target.value};return $`
    <div class="PuzzleInspector">
        <div>${n.id}</div>
        <div><input value=${n.name} onInput=${t}/></div>
        <div><input value=${n.next} onInput=${r}/></div>
        <div><input value=${n.hint} onInput=${s}/></div>
    </div>
    `}const Re={"0:0:0":{name:"New Puzzle",id:"0:0:0",entities:[{type:"BLOCK_1",pos:[-1,-2,0]},{type:"BLOCK_1",pos:[-2,-2,0]},{type:"BLOCK_1",pos:[-3,-2,0]},{type:"BLOCK_1",pos:[-3,-1,0]},{type:"BLOCK_1",pos:[-3,0,0]},{type:"BLOCK_1",pos:[-3,-2,1]},{type:"BLOCK_1",pos:[-3,-2,2]},{type:"WIZARD",pos:[-3,-2,3]}]},"3482db12:5e53a1fc:3a2226a1":{name:"Test Puzzle 1",id:"3482db12:5e53a1fc:3a2226a1",entities:[{type:"BLOCK_1",pos:[1,0,0]},{type:"BLOCK_1",pos:[0,0,0]},{type:"BLOCK_1",pos:[-1,0,0]},{type:"BLOCK_1",pos:[-1,-1,0]},{type:"BLOCK_1",pos:[-1,-2,0]},{type:"BLOCK_1",pos:[-1,-3,0]},{type:"BLOCK_1",pos:[2,0,0]},{type:"BLOCK_1",pos:[0,-1,0]},{type:"BLOCK_1",pos:[1,-1,0]},{type:"BLOCK_1",pos:[2,-1,0]},{type:"BLOCK_1",pos:[2,-3,0]},{type:"BLOCK_1",pos:[0,-2,0]},{type:"BLOCK_1",pos:[1,-2,0]},{type:"BLOCK_1",pos:[0,-3,0]},{type:"BLOCK_1",pos:[1,-3,0]},{type:"BLOCK_1",pos:[2,-2,0]},{type:"BLOCK_3",pos:[2,1,0]},{type:"BLOCK_1",pos:[1,1,0]},{type:"BLOCK_1",pos:[0,1,0]},{type:"BLOCK_1",pos:[-1,1,0]},{type:"BLOCK_1",pos:[-1,2,0]},{type:"BLOCK_1",pos:[0,2,0]},{type:"BLOCK_1",pos:[1,2,0]},{type:"BLOCK_1",pos:[2,2,0]},{type:"BLOCK_1",pos:[-1,3,0]},{type:"BLOCK_1",pos:[0,3,0]},{type:"BLOCK_1",pos:[1,3,0]},{type:"BLOCK_1",pos:[2,3,0]},{type:"BLOCK_1",pos:[-1,-3,1]},{type:"BLOCK_1",pos:[0,-3,1]},{type:"BLOCK_1",pos:[1,-3,1]},{type:"BLOCK_1",pos:[2,-3,1]},{type:"BLOCK_1",pos:[1,-2,1]},{type:"BLOCK_1",pos:[0,-2,1]},{type:"BLOCK_1",pos:[-1,-2,1]},{type:"BLOCK_1",pos:[2,-2,1]},{type:"BLOCK_1",pos:[1,-1,1]},{type:"BLOCK_1",pos:[0,-1,1]},{type:"BLOCK_1",pos:[-1,-1,1]},{type:"BLOCK_1",pos:[2,-1,1]},{type:"WIZARD",pos:[1,-2,2]},{type:"MIRROR_SW",pos:[1,-2,3]},{type:"MIRROR_SE",pos:[0,-1,2]},{type:"EXIT",pos:[0,4,0]}]},"fba135c:79b9cc87:66836e20":{name:"Test Puzzle 2",id:"fba135c:79b9cc87:66836e20",entities:[{type:"BLOCK_1",pos:[0,-1,0]},{type:"BLOCK_1",pos:[1,-1,0]},{type:"BLOCK_1",pos:[0,0,0]},{type:"BLOCK_1",pos:[1,0,0]},{type:"BLOCK_1",pos:[1,1,0]},{type:"BLOCK_1",pos:[2,1,0]},{type:"BLOCK_1",pos:[2,2,0]},{type:"BLOCK_1",pos:[3,2,0]},{type:"BLOCK_1",pos:[3,3,0]},{type:"BLOCK_1",pos:[3,4,0]},{type:"BLOCK_1",pos:[3,5,0]},{type:"BLOCK_1",pos:[4,5,0]},{type:"BLOCK_1",pos:[4,6,0]},{type:"BLOCK_1",pos:[5,6,0]},{type:"BOX",pos:[0,-1,1]},{type:"BOX",pos:[0,0,1]},{type:"BOX",pos:[0,0,2]},{type:"BOX",pos:[2,2,1]},{type:"BOX",pos:[2,2,2]},{type:"BOX",pos:[3,3,1]},{type:"BOX",pos:[3,4,1]},{type:"BOX",pos:[3,5,1]},{type:"WIZARD",pos:[1,-1,1]}]},"1cc4bc75:4ceb396a:374a6ece":{name:"Rotation Test",id:"1cc4bc75:4ceb396a:374a6ece",entities:[{type:"BLOCK_1",pos:[0,0,0]},{type:"BLOCK_1",pos:[0,1,0]},{type:"BLOCK_1",pos:[0,2,0]},{type:"BLOCK_1",pos:[1,2,0]},{type:"BLOCK_1",pos:[1,1,0]},{type:"BLOCK_1",pos:[1,0,0]},{type:"BLOCK_1",pos:[2,0,0]},{type:"BLOCK_1",pos:[2,1,0]},{type:"BLOCK_1",pos:[2,2,0]},{type:"MIRROR_SE",pos:[1,1,1]},{type:"WIZARD",pos:[1,0,1]}]},"58ae4d32:3760686a:19c2d9eb":{name:"Arch Test",id:"58ae4d32:3760686a:19c2d9eb",entities:[{type:"BLOCK_1",pos:[0,-2,0]},{type:"BLOCK_1",pos:[0,-3,0]},{type:"BLOCK_1",pos:[0,-4,0]},{type:"BLOCK_1",pos:[0,-5,0]},{type:"BLOCK_1",pos:[0,-6,0]},{type:"BLOCK_1",pos:[0,-7,0]},{type:"BLOCK_1",pos:[1,-2,0]},{type:"BLOCK_1",pos:[1,-3,0]},{type:"BLOCK_1",pos:[1,-4,0]},{type:"BLOCK_1",pos:[1,-5,0]},{type:"BLOCK_1",pos:[1,-6,0]},{type:"BLOCK_1",pos:[1,-7,0]},{type:"BLOCK_1",pos:[2,-2,0]},{type:"BLOCK_1",pos:[2,-3,0]},{type:"BLOCK_1",pos:[2,-4,0]},{type:"BLOCK_1",pos:[2,-5,0]},{type:"BLOCK_1",pos:[2,-6,0]},{type:"BLOCK_1",pos:[2,-7,0]},{type:"BLOCK_1",pos:[3,-7,0]},{type:"BLOCK_1",pos:[3,-6,0]},{type:"BLOCK_1",pos:[3,-5,0]},{type:"BLOCK_1",pos:[3,-4,0]},{type:"BLOCK_1",pos:[3,-3,0]},{type:"BLOCK_1",pos:[3,-2,0]},{type:"BLOCK_1",pos:[3,-5,1]},{type:"BLOCK_1",pos:[0,-5,1]},{type:"BLOCK_1",pos:[3,-5,2]},{type:"BLOCK_1",pos:[2,-5,2]},{type:"BLOCK_1",pos:[1,-5,2]},{type:"BLOCK_1",pos:[0,-5,2]},{type:"WIZARD",pos:[1,-2,1]},{type:"BOX",pos:[2,-3,1]},{type:"BOX",pos:[2,-3,2]},{type:"EXIT",pos:[4,-5,0]}]},"775c6d08:1751db2:1c5bf3d4":{name:"1",next:"2",id:"775c6d08:1751db2:1c5bf3d4",entities:[{type:"BLOCK_1",pos:[0,0,0]},{type:"BLOCK_1",pos:[-1,0,0]},{type:"BLOCK_1",pos:[-2,0,0]},{type:"BLOCK_1",pos:[0,-1,0]},{type:"BLOCK_1",pos:[-1,-1,0]},{type:"BLOCK_1",pos:[-2,-1,0]},{type:"BLOCK_1",pos:[0,-2,0]},{type:"BLOCK_1",pos:[-1,-2,0]},{type:"BLOCK_1",pos:[-2,-2,0]},{type:"EXIT",pos:[-1,-3,0]},{type:"WIZARD",pos:[-1,0,1]}]},"28c04bdb:18d64cd:2dcda608":{name:"Pulse Test",id:"28c04bdb:18d64cd:2dcda608",entities:[{type:"BLOCK_1",pos:[-1,0,0]},{type:"BLOCK_1",pos:[-1,-1,0]},{type:"BLOCK_1",pos:[-1,-2,0]},{type:"BLOCK_1",pos:[-1,-3,0]},{type:"BLOCK_1",pos:[-1,1,0]},{type:"BLOCK_1",pos:[0,1,0]},{type:"BLOCK_1",pos:[0,0,0]},{type:"BLOCK_1",pos:[0,-1,0]},{type:"BLOCK_1",pos:[0,-2,0]},{type:"BLOCK_1",pos:[0,-3,0]},{type:"BLOCK_1",pos:[1,1,0]},{type:"BLOCK_1",pos:[1,0,0]},{type:"BLOCK_1",pos:[1,-1,0]},{type:"BLOCK_1",pos:[1,-2,0]},{type:"BLOCK_1",pos:[1,-3,0]},{type:"BOX",pos:[0,-2,1]},{type:"WIZARD",pos:[0,0,1]},{type:"EXIT",pos:[2,-3,0]}]},"486c3da8:6351cc70:78222ea5":{name:"2",next:"3",id:"486c3da8:6351cc70:78222ea5",entities:[{type:"BLOCK_3",pos:[0,1,0]},{type:"BLOCK_3",pos:[1,1,0]},{type:"BLOCK_3",pos:[2,1,0]},{type:"BLOCK_3",pos:[2,2,0]},{type:"BLOCK_3",pos:[1,2,0]},{type:"BLOCK_3",pos:[0,2,0]},{type:"BLOCK_3",pos:[1,3,0]},{type:"BLOCK_3",pos:[0,3,0]},{type:"BLOCK_3",pos:[2,3,0]},{type:"EXIT",pos:[1,5,0]},{type:"BOX",pos:[1,2,1]},{type:"WIZARD",pos:[1,2,2]}]},"3970d4a5:701d6c24:781dbf61":{name:"3",next:"4",id:"3970d4a5:701d6c24:781dbf61",hint:"",entities:[{type:"BLOCK_1",pos:[0,1,0]},{type:"BLOCK_1",pos:[1,1,0]},{type:"BLOCK_1",pos:[0,2,0]},{type:"BLOCK_1",pos:[1,2,0]},{type:"BLOCK_1",pos:[0,2,1]},{type:"BLOCK_1",pos:[1,2,1]},{type:"BLOCK_1",pos:[1,1,1]},{type:"BLOCK_1",pos:[0,1,1]},{type:"BOX",pos:[1,1,2]},{type:"WIZARD",pos:[0,1,2]},{type:"BLOCK_1",pos:[2,1,0]},{type:"BLOCK_1",pos:[2,1,1]},{type:"BLOCK_1",pos:[3,1,0]},{type:"BLOCK_1",pos:[0,0,0]},{type:"BLOCK_1",pos:[1,0,0]},{type:"BLOCK_1",pos:[2,0,0]},{type:"BLOCK_1",pos:[3,0,0]},{type:"BLOCK_1",pos:[0,0,1]},{type:"BLOCK_1",pos:[1,0,1]},{type:"BLOCK_1",pos:[2,0,1]},{type:"BLOCK_1",pos:[2,2,0]},{type:"BLOCK_1",pos:[3,2,0]},{type:"EXIT",pos:[3,5,0]},{type:"BOX",pos:[1,0,2]},{type:"BLOCK_1",pos:[0,-1,0]},{type:"BLOCK_1",pos:[1,-1,0]},{type:"BLOCK_1",pos:[2,-1,0]},{type:"BLOCK_1",pos:[0,-1,1]},{type:"BLOCK_1",pos:[1,-1,1]},{type:"BLOCK_1",pos:[2,-1,1]}]},"5cbeaef1:75154f2d:3018d133":{name:"4",next:"5",id:"5cbeaef1:75154f2d:3018d133",hint:"press I, J, K, L<br>to cast magic missile ",entities:[{type:"BLOCK_1",pos:[3,4,0]},{type:"BLOCK_1",pos:[3,3,0]},{type:"BLOCK_1",pos:[3,2,0]},{type:"BLOCK_1",pos:[3,1,0]},{type:"BLOCK_1",pos:[3,0,0]},{type:"BLOCK_1",pos:[3,-1,0]},{type:"BLOCK_1",pos:[2,-1,0]},{type:"BLOCK_1",pos:[1,-1,0]},{type:"BLOCK_1",pos:[0,-1,0]},{type:"BLOCK_1",pos:[-1,-1,0]},{type:"BLOCK_1",pos:[-2,-1,0]},{type:"BLOCK_1",pos:[-2,-2,0]},{type:"BLOCK_1",pos:[-1,-2,0]},{type:"BLOCK_1",pos:[0,-2,0]},{type:"BLOCK_1",pos:[1,-2,0]},{type:"BLOCK_1",pos:[2,-2,0]},{type:"BLOCK_1",pos:[3,-2,0]},{type:"BLOCK_1",pos:[4,-2,0]},{type:"BLOCK_1",pos:[4,-1,0]},{type:"BLOCK_1",pos:[4,0,0]},{type:"BLOCK_1",pos:[4,1,0]},{type:"BLOCK_1",pos:[4,2,0]},{type:"BLOCK_1",pos:[4,3,0]},{type:"BLOCK_1",pos:[4,4,0]},{type:"BLOCK_1",pos:[4,2,1]},{type:"BOX",pos:[4,2,2]},{type:"BLOCK_3",pos:[1,-2,1]},{type:"BLOCK_3",pos:[2,-2,1]},{type:"BLOCK_3",pos:[0,-2,1]},{type:"BLOCK_1",pos:[-2,-3,0]},{type:"BLOCK_1",pos:[-1,-3,0]},{type:"BLOCK_1",pos:[0,-3,0]},{type:"BLOCK_1",pos:[1,-3,0]},{type:"BLOCK_1",pos:[2,-3,0]},{type:"BLOCK_1",pos:[3,-3,0]},{type:"BLOCK_1",pos:[4,-3,0]},{type:"BLOCK_1",pos:[0,-3,1]},{type:"BLOCK_1",pos:[1,-3,1]},{type:"BLOCK_1",pos:[2,-3,1]},{type:"BLOCK_1",pos:[5,4,0]},{type:"BLOCK_1",pos:[5,3,0]},{type:"BLOCK_1",pos:[5,2,0]},{type:"BLOCK_1",pos:[5,0,0]},{type:"BLOCK_1",pos:[5,1,0]},{type:"BLOCK_1",pos:[5,-1,0]},{type:"BLOCK_1",pos:[5,-2,0]},{type:"BLOCK_1",pos:[5,-3,0]},{type:"BLOCK_1",pos:[-2,-4,0]},{type:"BLOCK_1",pos:[-1,-4,0]},{type:"BLOCK_1",pos:[0,-4,0]},{type:"BLOCK_1",pos:[1,-4,0]},{type:"BLOCK_1",pos:[2,-4,0]},{type:"BLOCK_1",pos:[3,-4,0]},{type:"BLOCK_1",pos:[4,-4,0]},{type:"BLOCK_1",pos:[5,-4,0]},{type:"BLOCK_1",pos:[2,-4,1]},{type:"BLOCK_1",pos:[1,-4,1]},{type:"BLOCK_1",pos:[0,-4,1]},{type:"BOX",pos:[1,-3,2]},{type:"WIZARD",pos:[1,-3,3]},{type:"BOX",pos:[2,-3,2]},{type:"EXIT",pos:[-1,4,0]}]}};class X{static loadPuzzle(n){{const t=Re;return console.log(t[n]),G.deserialize(t[n])}}static savePuzzle(n){}static saveManifest(){}static loadManifest(){{const n=Re;this.manifest={},Object.keys(n).forEach(t=>{this.manifest[t]=n[t].name});return}}static getPuzzleList(){return[]}static loadLastPuzzle(){const n=localStorage.getItem("lastPuzzle")||"";return this.loadPuzzle(n)}static loadPuzzleByName(n){this.loadManifest(),console.log(this.manifest);for(const t of Object.keys(this.manifest))if(this.manifest[t]===n)return this.loadPuzzle(t);return null}static export(){const n={};for(const t of Object.keys(this.manifest)){const r=JSON.parse(localStorage.getItem(t));n[t]=r}return n}}m(X,"manifest",{});class Ct{constructor(n,t){m(this,"puzzle",new G);m(this,"renderList",[]);m(this,"entityAtPoint",null);m(this,"undoList",[]);m(this,"redoList",[]);m(this,"activeBrush",null);m(this,"brushes",[]);m(this,"tools",[]);m(this,"prototypes",{});m(this,"pickTimeout",0);m(this,"rotation",0);m(this,"showFolder",!1);m(this,"loadPuzzle",n=>{K.clear(),this.renderList.length=0,this.puzzle=X.loadPuzzle(n),this.init()});m(this,"computeEntityAtPoint",(n,t)=>{const r=Ne(this.g.canvas,this.getOffset(),this.renderList,n,t);return K.byId.get(r)||null});m(this,"updateEntityAtPoint",(n,t)=>{this.pickTimeout>0||(this.pickTimeout=ot,this.entityAtPoint=this.computeEntityAtPoint(n,t))});m(this,"onKeyDown",n=>{switch(n.key){case"Escape":this.showFolder=!1;break;case"F10":console.log(JSON.stringify(X.export(),null,2));break}});m(this,"onMouseMove",n=>{this.entityAtPoint=this.computeEntityAtPoint(n.clientX,n.clientY)});m(this,"onMouseDown",n=>{this.entityAtPoint=this.computeEntityAtPoint(n.clientX,n.clientY),this.activeBrush!=null&&this.handleInput()});m(this,"handlePaletteClick",n=>{if(this.activeBrush=null,n.type==="FOLDER"){this.showFolder=!0;return}if(n.type==="PLUS"&&(this.puzzle=new G,this.renderList.length=0,this.init()),n.type==="ROTATE_RIGHT"){this.puzzle.rotateRight(),this.sortRenderList();return}if(n.type==="ROTATE_LEFT"){this.puzzle.rotateLeft(),this.sortRenderList();return}if(n.type==="SAVE"){console.log("saving"),X.savePuzzle(this.puzzle),console.log(this.puzzle.serialize());return}n.type==="PLAY"&&(this.g.popScreen(),this.g.pushScreen(new ue(this.g,this.puzzle))),this.activeBrush=n});m(this,"onContextMenu",n=>(n.preventDefault(),n.stopPropagation(),!1));this.g=n,t=t||new G,this.puzzle=t,this.init()}update(){this.pickTimeout-=this.g.dt,this.updateAnimations()}resetScreenPositions(){for(const n of this.puzzle.actors)n.screenPos=T.create(n.pos.x,n.pos.y,n.pos.z)}init(){for(const n of this.puzzle.v2e.values())this.renderList.push(n);this.addCallbacks(),this.addBaseEntities(),this.setupBrushes(),this.setupTools(),this.setupPrototypes()}onExit(){this.removeCallbacks(),Ee(null,document.body)}setupPrototypes(){this.prototypes={BLOCK_1:{type:"BLOCK",frames:[A.block[0]]},BLOCK_2:{type:"BLOCK",frames:[A.block[1]]},BLOCK_3:{type:"BLOCK",frames:[A.block[2]]},WIZARD:{type:"WIZARD",frames:A.wiz,frameDuration:96},MIRROR_SE:{type:"MIRROR_SE",frames:A["mirror-se"],frameDuration:128},MIRROR_SW:{type:"MIRROR_SW",frames:A["mirror-sw"],frameDuration:128},MIRROR_NE:{type:"MIRROR_NE",frames:A["mirror-ne"]},MIRROR_NW:{type:"MIRROR_NW",frames:A["mirror-nw"]}}}setupTools(){this.tools=[{type:"ROTATE_LEFT",sprite:A["rotate-right"][0]},{type:"ROTATE_RIGHT",sprite:A["rotate-left"][0]},{type:"PLAY",sprite:A.play[0]},{type:"SAVE",sprite:A.save[0]},{type:"FOLDER",sprite:A.folder[0]},{type:"PLUS",sprite:A.plus[0]},{type:"COPY",sprite:A.copy[0]},{type:"UNDO",sprite:A.undo[0]},{type:"REDO",sprite:A.redo[0]}]}setupBrushes(){this.brushes=[{type:"ERASER",sprite:A.eraser[0]},{type:"WIZARD",sprite:A.wiz[0]},{type:"BLOCK_1",sprite:A.block[0]},{type:"BLOCK_2",sprite:A.block[1]},{type:"BLOCK_3",sprite:A.block[2]},{type:"MIRROR_SE",sprite:A["mirror-se"][0]},{type:"MIRROR_SW",sprite:A["mirror-sw"][0]},{type:"MIRROR_NW",sprite:A["mirror-nw"][0]},{type:"MIRROR_NE",sprite:A["mirror-ne"][0]},{type:"EXIT",sprite:A.exit[0]},{type:"BOX",sprite:A.box[0]}]}addBaseEntities(){for(let r=-16;r<16;r++)for(let s=-16;s<16;s++){const a=new K;a.pos=L.create(r,s,-1),a.screenPos=T.create(r,s,-1),a.frames=A["block-frame"],a.frameIndex=0,me(a),this.renderList.push(a)}}addCallbacks(){this.g.canvas.addEventListener("mousemove",this.onMouseMove),this.g.canvas.addEventListener("mousedown",this.onMouseDown),this.g.canvas.addEventListener("keydown",this.onKeyDown),this.g.canvas.oncontextmenu=this.onContextMenu}removeCallbacks(){this.g.canvas.removeEventListener("mousemove",this.onMouseMove),this.g.canvas.removeEventListener("mousedown",this.onMouseDown),this.g.canvas.removeEventListener("keydown",this.onKeyDown),this.g.canvas.oncontextmenu=null}handleInput(){var n;if(!(this.entityAtPoint==null||this.activeBrush==null)){if(this.activeBrush.type==="ERASER"){if(!this.puzzle.v2e.has(this.entityAtPoint.pos))return;this.deleteEntity(this.entityAtPoint);return}this.createEntity((n=this.activeBrush)==null?void 0:n.type,L.add(this.entityAtPoint.pos,L.up))}}createEntity(n,t){const r=this.puzzle.createEntity(n,t);this.renderList.push(r),this.sortRenderList()}deleteEntity(n){this.puzzle.v2e.delete(n.pos);const t=this.renderList.indexOf(n);t!==-1&&this.renderList.splice(t,1)}updateAnimations(){const{dt:n}=this.g;for(const t of this.puzzle.v2e.values())t.frameDuration!==0&&(t.frameElapsed+=n,t.frameElapsed>=t.frameDuration&&(t.frameElapsed=t.frameElapsed%t.frameDuration,t.frameIndex=(t.frameIndex+1)%t.frames.length))}render(){const{canvas:n}=this.g;n.getContext("2d").clearRect(0,0,n.width,n.height),this.sortRenderList(),this.renderEntities(),this.renderHighlight(),this.renderUi()}renderUi(){const n=Se({className:"Toolbar",brushes:this.tools,activeBrush:this.activeBrush,handleClick:this.handlePaletteClick}),t=Se({className:"Palette",brushes:this.brushes,activeBrush:this.activeBrush,handleClick:this.handlePaletteClick}),r=xt({puzzle:this.puzzle}),s=this.showFolder&&Bt({puzzles:X.getPuzzleList(),handleClick:this.loadPuzzle}),a=$`
            <div class="EditorUi">
                ${n}
                ${t}
                ${s}
                ${r}
            </div>
        `;Ee(a,document.body)}sortRenderList(){this.renderList.sort((n,t)=>{const r=n.screenPos.x+n.screenPos.y,s=t.screenPos.x+t.screenPos.y;return r<s?-1:s<r?1:n.pos.z<t.pos.z?-1:t.pos.z<n.pos.z?1:0})}renderEntities(){this.sortRenderList(),ve(this.g.canvas,this.getOffset(),this.renderList)}renderHighlight(){this.entityAtPoint!==null&&He(this.g.canvas,this.getOffset(),this.entityAtPoint,A["block-highlight"][0])}getOffset(){return T.create(this.g.canvas.width/2,this.g.canvas.height/2,0)}tick(){this.update(),this.render()}}var q=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},he={};/*!
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(p){(function(){var n=function(){this.init()};n.prototype={init:function(){var e=this||t;return e._counter=1e3,e._html5AudioPool=[],e.html5PoolSize=10,e._codecs={},e._howls=[],e._muted=!1,e._volume=1,e._canPlayEvent="canplaythrough",e._navigator=typeof window<"u"&&window.navigator?window.navigator:null,e.masterGain=null,e.noAudio=!1,e.usingWebAudio=!0,e.autoSuspend=!0,e.ctx=null,e.autoUnlock=!0,e._setup(),e},volume:function(e){var o=this||t;if(e=parseFloat(e),o.ctx||v(),typeof e<"u"&&e>=0&&e<=1){if(o._volume=e,o._muted)return o;o.usingWebAudio&&o.masterGain.gain.setValueAtTime(e,t.ctx.currentTime);for(var i=0;i<o._howls.length;i++)if(!o._howls[i]._webAudio)for(var l=o._howls[i]._getSoundIds(),d=0;d<l.length;d++){var f=o._howls[i]._soundById(l[d]);f&&f._node&&(f._node.volume=f._volume*e)}return o}return o._volume},mute:function(e){var o=this||t;o.ctx||v(),o._muted=e,o.usingWebAudio&&o.masterGain.gain.setValueAtTime(e?0:o._volume,t.ctx.currentTime);for(var i=0;i<o._howls.length;i++)if(!o._howls[i]._webAudio)for(var l=o._howls[i]._getSoundIds(),d=0;d<l.length;d++){var f=o._howls[i]._soundById(l[d]);f&&f._node&&(f._node.muted=e?!0:f._muted)}return o},stop:function(){for(var e=this||t,o=0;o<e._howls.length;o++)e._howls[o].stop();return e},unload:function(){for(var e=this||t,o=e._howls.length-1;o>=0;o--)e._howls[o].unload();return e.usingWebAudio&&e.ctx&&typeof e.ctx.close<"u"&&(e.ctx.close(),e.ctx=null,v()),e},codecs:function(e){return(this||t)._codecs[e.replace(/^x-/,"")]},_setup:function(){var e=this||t;if(e.state=e.ctx&&e.ctx.state||"suspended",e._autoSuspend(),!e.usingWebAudio)if(typeof Audio<"u")try{var o=new Audio;typeof o.oncanplaythrough>"u"&&(e._canPlayEvent="canplay")}catch{e.noAudio=!0}else e.noAudio=!0;try{var o=new Audio;o.muted&&(e.noAudio=!0)}catch{}return e.noAudio||e._setupCodecs(),e},_setupCodecs:function(){var e=this||t,o=null;try{o=typeof Audio<"u"?new Audio:null}catch{return e}if(!o||typeof o.canPlayType!="function")return e;var i=o.canPlayType("audio/mpeg;").replace(/^no$/,""),l=e._navigator?e._navigator.userAgent:"",d=l.match(/OPR\/(\d+)/g),f=d&&parseInt(d[0].split("/")[1],10)<33,c=l.indexOf("Safari")!==-1&&l.indexOf("Chrome")===-1,g=l.match(/Version\/(.*?) /),O=c&&g&&parseInt(g[1],10)<15;return e._codecs={mp3:!!(!f&&(i||o.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!i,opus:!!o.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!o.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!o.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(o.canPlayType('audio/wav; codecs="1"')||o.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!o.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!o.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(o.canPlayType("audio/x-m4a;")||o.canPlayType("audio/m4a;")||o.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(o.canPlayType("audio/x-m4b;")||o.canPlayType("audio/m4b;")||o.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(o.canPlayType("audio/x-mp4;")||o.canPlayType("audio/mp4;")||o.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!O&&o.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!O&&o.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!o.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(o.canPlayType("audio/x-flac;")||o.canPlayType("audio/flac;")).replace(/^no$/,"")},e},_unlockAudio:function(){var e=this||t;if(!(e._audioUnlocked||!e.ctx)){e._audioUnlocked=!1,e.autoUnlock=!1,!e._mobileUnloaded&&e.ctx.sampleRate!==44100&&(e._mobileUnloaded=!0,e.unload()),e._scratchBuffer=e.ctx.createBuffer(1,1,22050);var o=function(i){for(;e._html5AudioPool.length<e.html5PoolSize;)try{var l=new Audio;l._unlocked=!0,e._releaseHtml5Audio(l)}catch{e.noAudio=!0;break}for(var d=0;d<e._howls.length;d++)if(!e._howls[d]._webAudio)for(var f=e._howls[d]._getSoundIds(),c=0;c<f.length;c++){var g=e._howls[d]._soundById(f[c]);g&&g._node&&!g._node._unlocked&&(g._node._unlocked=!0,g._node.load())}e._autoResume();var O=e.ctx.createBufferSource();O.buffer=e._scratchBuffer,O.connect(e.ctx.destination),typeof O.start>"u"?O.noteOn(0):O.start(0),typeof e.ctx.resume=="function"&&e.ctx.resume(),O.onended=function(){O.disconnect(0),e._audioUnlocked=!0,document.removeEventListener("touchstart",o,!0),document.removeEventListener("touchend",o,!0),document.removeEventListener("click",o,!0),document.removeEventListener("keydown",o,!0);for(var b=0;b<e._howls.length;b++)e._howls[b]._emit("unlock")}};return document.addEventListener("touchstart",o,!0),document.addEventListener("touchend",o,!0),document.addEventListener("click",o,!0),document.addEventListener("keydown",o,!0),e}},_obtainHtml5Audio:function(){var e=this||t;if(e._html5AudioPool.length)return e._html5AudioPool.pop();var o=new Audio().play();return o&&typeof Promise<"u"&&(o instanceof Promise||typeof o.then=="function")&&o.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(e){var o=this||t;return e._unlocked&&o._html5AudioPool.push(e),o},_autoSuspend:function(){var e=this;if(!(!e.autoSuspend||!e.ctx||typeof e.ctx.suspend>"u"||!t.usingWebAudio)){for(var o=0;o<e._howls.length;o++)if(e._howls[o]._webAudio){for(var i=0;i<e._howls[o]._sounds.length;i++)if(!e._howls[o]._sounds[i]._paused)return e}return e._suspendTimer&&clearTimeout(e._suspendTimer),e._suspendTimer=setTimeout(function(){if(e.autoSuspend){e._suspendTimer=null,e.state="suspending";var l=function(){e.state="suspended",e._resumeAfterSuspend&&(delete e._resumeAfterSuspend,e._autoResume())};e.ctx.suspend().then(l,l)}},3e4),e}},_autoResume:function(){var e=this;if(!(!e.ctx||typeof e.ctx.resume>"u"||!t.usingWebAudio))return e.state==="running"&&e.ctx.state!=="interrupted"&&e._suspendTimer?(clearTimeout(e._suspendTimer),e._suspendTimer=null):e.state==="suspended"||e.state==="running"&&e.ctx.state==="interrupted"?(e.ctx.resume().then(function(){e.state="running";for(var o=0;o<e._howls.length;o++)e._howls[o]._emit("resume")}),e._suspendTimer&&(clearTimeout(e._suspendTimer),e._suspendTimer=null)):e.state==="suspending"&&(e._resumeAfterSuspend=!0),e}};var t=new n,r=function(e){var o=this;if(!e.src||e.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}o.init(e)};r.prototype={init:function(e){var o=this;return t.ctx||v(),o._autoplay=e.autoplay||!1,o._format=typeof e.format!="string"?e.format:[e.format],o._html5=e.html5||!1,o._muted=e.mute||!1,o._loop=e.loop||!1,o._pool=e.pool||5,o._preload=typeof e.preload=="boolean"||e.preload==="metadata"?e.preload:!0,o._rate=e.rate||1,o._sprite=e.sprite||{},o._src=typeof e.src!="string"?e.src:[e.src],o._volume=e.volume!==void 0?e.volume:1,o._xhr={method:e.xhr&&e.xhr.method?e.xhr.method:"GET",headers:e.xhr&&e.xhr.headers?e.xhr.headers:null,withCredentials:e.xhr&&e.xhr.withCredentials?e.xhr.withCredentials:!1},o._duration=0,o._state="unloaded",o._sounds=[],o._endTimers={},o._queue=[],o._playLock=!1,o._onend=e.onend?[{fn:e.onend}]:[],o._onfade=e.onfade?[{fn:e.onfade}]:[],o._onload=e.onload?[{fn:e.onload}]:[],o._onloaderror=e.onloaderror?[{fn:e.onloaderror}]:[],o._onplayerror=e.onplayerror?[{fn:e.onplayerror}]:[],o._onpause=e.onpause?[{fn:e.onpause}]:[],o._onplay=e.onplay?[{fn:e.onplay}]:[],o._onstop=e.onstop?[{fn:e.onstop}]:[],o._onmute=e.onmute?[{fn:e.onmute}]:[],o._onvolume=e.onvolume?[{fn:e.onvolume}]:[],o._onrate=e.onrate?[{fn:e.onrate}]:[],o._onseek=e.onseek?[{fn:e.onseek}]:[],o._onunlock=e.onunlock?[{fn:e.onunlock}]:[],o._onresume=[],o._webAudio=t.usingWebAudio&&!o._html5,typeof t.ctx<"u"&&t.ctx&&t.autoUnlock&&t._unlockAudio(),t._howls.push(o),o._autoplay&&o._queue.push({event:"play",action:function(){o.play()}}),o._preload&&o._preload!=="none"&&o.load(),o},load:function(){var e=this,o=null;if(t.noAudio){e._emit("loaderror",null,"No audio support.");return}typeof e._src=="string"&&(e._src=[e._src]);for(var i=0;i<e._src.length;i++){var l,d;if(e._format&&e._format[i])l=e._format[i];else{if(d=e._src[i],typeof d!="string"){e._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}l=/^data:audio\/([^;,]+);/i.exec(d),l||(l=/\.([^.]+)$/.exec(d.split("?",1)[0])),l&&(l=l[1].toLowerCase())}if(l||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),l&&t.codecs(l)){o=e._src[i];break}}if(!o){e._emit("loaderror",null,"No codec support for selected audio sources.");return}return e._src=o,e._state="loading",window.location.protocol==="https:"&&o.slice(0,5)==="http:"&&(e._html5=!0,e._webAudio=!1),new s(e),e._webAudio&&u(e),e},play:function(e,o){var i=this,l=null;if(typeof e=="number")l=e,e=null;else{if(typeof e=="string"&&i._state==="loaded"&&!i._sprite[e])return null;if(typeof e>"u"&&(e="__default",!i._playLock)){for(var d=0,f=0;f<i._sounds.length;f++)i._sounds[f]._paused&&!i._sounds[f]._ended&&(d++,l=i._sounds[f]._id);d===1?e=null:l=null}}var c=l?i._soundById(l):i._inactiveSound();if(!c)return null;if(l&&!e&&(e=c._sprite||"__default"),i._state!=="loaded"){c._sprite=e,c._ended=!1;var g=c._id;return i._queue.push({event:"play",action:function(){i.play(g)}}),g}if(l&&!c._paused)return o||i._loadQueue("play"),c._id;i._webAudio&&t._autoResume();var O=Math.max(0,c._seek>0?c._seek:i._sprite[e][0]/1e3),b=Math.max(0,(i._sprite[e][0]+i._sprite[e][1])/1e3-O),P=b*1e3/Math.abs(c._rate),k=i._sprite[e][0]/1e3,S=(i._sprite[e][0]+i._sprite[e][1])/1e3;c._sprite=e,c._ended=!1;var D=function(){c._paused=!1,c._seek=O,c._start=k,c._stop=S,c._loop=!!(c._loop||i._sprite[e][2])};if(O>=S){i._ended(c);return}var w=c._node;if(i._webAudio){var F=function(){i._playLock=!1,D(),i._refreshBuffer(c);var Z=c._muted||i._muted?0:c._volume;w.gain.setValueAtTime(Z,t.ctx.currentTime),c._playStart=t.ctx.currentTime,typeof w.bufferSource.start>"u"?c._loop?w.bufferSource.noteGrainOn(0,O,86400):w.bufferSource.noteGrainOn(0,O,b):c._loop?w.bufferSource.start(0,O,86400):w.bufferSource.start(0,O,b),P!==1/0&&(i._endTimers[c._id]=setTimeout(i._ended.bind(i,c),P)),o||setTimeout(function(){i._emit("play",c._id),i._loadQueue()},0)};t.state==="running"&&t.ctx.state!=="interrupted"?F():(i._playLock=!0,i.once("resume",F),i._clearTimer(c._id))}else{var Le=function(){w.currentTime=O,w.muted=c._muted||i._muted||t._muted||w.muted,w.volume=c._volume*t.volume(),w.playbackRate=c._rate;try{var Z=w.play();if(Z&&typeof Promise<"u"&&(Z instanceof Promise||typeof Z.then=="function")?(i._playLock=!0,D(),Z.then(function(){i._playLock=!1,w._unlocked=!0,o?i._loadQueue():i._emit("play",c._id)}).catch(function(){i._playLock=!1,i._emit("playerror",c._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),c._ended=!0,c._paused=!0})):o||(i._playLock=!1,D(),i._emit("play",c._id)),w.playbackRate=c._rate,w.paused){i._emit("playerror",c._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}e!=="__default"||c._loop?i._endTimers[c._id]=setTimeout(i._ended.bind(i,c),P):(i._endTimers[c._id]=function(){i._ended(c),w.removeEventListener("ended",i._endTimers[c._id],!1)},w.addEventListener("ended",i._endTimers[c._id],!1))}catch(Je){i._emit("playerror",c._id,Je)}};w.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(w.src=i._src,w.load());var je=window&&window.ejecta||!w.readyState&&t._navigator.isCocoonJS;if(w.readyState>=3||je)Le();else{i._playLock=!0,i._state="loading";var Ae=function(){i._state="loaded",Le(),w.removeEventListener(t._canPlayEvent,Ae,!1)};w.addEventListener(t._canPlayEvent,Ae,!1),i._clearTimer(c._id)}}return c._id},pause:function(e){var o=this;if(o._state!=="loaded"||o._playLock)return o._queue.push({event:"pause",action:function(){o.pause(e)}}),o;for(var i=o._getSoundIds(e),l=0;l<i.length;l++){o._clearTimer(i[l]);var d=o._soundById(i[l]);if(d&&!d._paused&&(d._seek=o.seek(i[l]),d._rateSeek=0,d._paused=!0,o._stopFade(i[l]),d._node))if(o._webAudio){if(!d._node.bufferSource)continue;typeof d._node.bufferSource.stop>"u"?d._node.bufferSource.noteOff(0):d._node.bufferSource.stop(0),o._cleanBuffer(d._node)}else(!isNaN(d._node.duration)||d._node.duration===1/0)&&d._node.pause();arguments[1]||o._emit("pause",d?d._id:null)}return o},stop:function(e,o){var i=this;if(i._state!=="loaded"||i._playLock)return i._queue.push({event:"stop",action:function(){i.stop(e)}}),i;for(var l=i._getSoundIds(e),d=0;d<l.length;d++){i._clearTimer(l[d]);var f=i._soundById(l[d]);f&&(f._seek=f._start||0,f._rateSeek=0,f._paused=!0,f._ended=!0,i._stopFade(l[d]),f._node&&(i._webAudio?f._node.bufferSource&&(typeof f._node.bufferSource.stop>"u"?f._node.bufferSource.noteOff(0):f._node.bufferSource.stop(0),i._cleanBuffer(f._node)):(!isNaN(f._node.duration)||f._node.duration===1/0)&&(f._node.currentTime=f._start||0,f._node.pause(),f._node.duration===1/0&&i._clearSound(f._node))),o||i._emit("stop",f._id))}return i},mute:function(e,o){var i=this;if(i._state!=="loaded"||i._playLock)return i._queue.push({event:"mute",action:function(){i.mute(e,o)}}),i;if(typeof o>"u")if(typeof e=="boolean")i._muted=e;else return i._muted;for(var l=i._getSoundIds(o),d=0;d<l.length;d++){var f=i._soundById(l[d]);f&&(f._muted=e,f._interval&&i._stopFade(f._id),i._webAudio&&f._node?f._node.gain.setValueAtTime(e?0:f._volume,t.ctx.currentTime):f._node&&(f._node.muted=t._muted?!0:e),i._emit("mute",f._id))}return i},volume:function(){var e=this,o=arguments,i,l;if(o.length===0)return e._volume;if(o.length===1||o.length===2&&typeof o[1]>"u"){var d=e._getSoundIds(),f=d.indexOf(o[0]);f>=0?l=parseInt(o[0],10):i=parseFloat(o[0])}else o.length>=2&&(i=parseFloat(o[0]),l=parseInt(o[1],10));var c;if(typeof i<"u"&&i>=0&&i<=1){if(e._state!=="loaded"||e._playLock)return e._queue.push({event:"volume",action:function(){e.volume.apply(e,o)}}),e;typeof l>"u"&&(e._volume=i),l=e._getSoundIds(l);for(var g=0;g<l.length;g++)c=e._soundById(l[g]),c&&(c._volume=i,o[2]||e._stopFade(l[g]),e._webAudio&&c._node&&!c._muted?c._node.gain.setValueAtTime(i,t.ctx.currentTime):c._node&&!c._muted&&(c._node.volume=i*t.volume()),e._emit("volume",c._id))}else return c=l?e._soundById(l):e._sounds[0],c?c._volume:0;return e},fade:function(e,o,i,l){var d=this;if(d._state!=="loaded"||d._playLock)return d._queue.push({event:"fade",action:function(){d.fade(e,o,i,l)}}),d;e=Math.min(Math.max(0,parseFloat(e)),1),o=Math.min(Math.max(0,parseFloat(o)),1),i=parseFloat(i),d.volume(e,l);for(var f=d._getSoundIds(l),c=0;c<f.length;c++){var g=d._soundById(f[c]);if(g){if(l||d._stopFade(f[c]),d._webAudio&&!g._muted){var O=t.ctx.currentTime,b=O+i/1e3;g._volume=e,g._node.gain.setValueAtTime(e,O),g._node.gain.linearRampToValueAtTime(o,b)}d._startFadeInterval(g,e,o,i,f[c],typeof l>"u")}}return d},_startFadeInterval:function(e,o,i,l,d,f){var c=this,g=o,O=i-o,b=Math.abs(O/.01),P=Math.max(4,b>0?l/b:l),k=Date.now();e._fadeTo=i,e._interval=setInterval(function(){var S=(Date.now()-k)/l;k=Date.now(),g+=O*S,g=Math.round(g*100)/100,O<0?g=Math.max(i,g):g=Math.min(i,g),c._webAudio?e._volume=g:c.volume(g,e._id,!0),f&&(c._volume=g),(i<o&&g<=i||i>o&&g>=i)&&(clearInterval(e._interval),e._interval=null,e._fadeTo=null,c.volume(i,e._id),c._emit("fade",e._id))},P)},_stopFade:function(e){var o=this,i=o._soundById(e);return i&&i._interval&&(o._webAudio&&i._node.gain.cancelScheduledValues(t.ctx.currentTime),clearInterval(i._interval),i._interval=null,o.volume(i._fadeTo,e),i._fadeTo=null,o._emit("fade",e)),o},loop:function(){var e=this,o=arguments,i,l,d;if(o.length===0)return e._loop;if(o.length===1)if(typeof o[0]=="boolean")i=o[0],e._loop=i;else return d=e._soundById(parseInt(o[0],10)),d?d._loop:!1;else o.length===2&&(i=o[0],l=parseInt(o[1],10));for(var f=e._getSoundIds(l),c=0;c<f.length;c++)d=e._soundById(f[c]),d&&(d._loop=i,e._webAudio&&d._node&&d._node.bufferSource&&(d._node.bufferSource.loop=i,i&&(d._node.bufferSource.loopStart=d._start||0,d._node.bufferSource.loopEnd=d._stop,e.playing(f[c])&&(e.pause(f[c],!0),e.play(f[c],!0)))));return e},rate:function(){var e=this,o=arguments,i,l;if(o.length===0)l=e._sounds[0]._id;else if(o.length===1){var d=e._getSoundIds(),f=d.indexOf(o[0]);f>=0?l=parseInt(o[0],10):i=parseFloat(o[0])}else o.length===2&&(i=parseFloat(o[0]),l=parseInt(o[1],10));var c;if(typeof i=="number"){if(e._state!=="loaded"||e._playLock)return e._queue.push({event:"rate",action:function(){e.rate.apply(e,o)}}),e;typeof l>"u"&&(e._rate=i),l=e._getSoundIds(l);for(var g=0;g<l.length;g++)if(c=e._soundById(l[g]),c){e.playing(l[g])&&(c._rateSeek=e.seek(l[g]),c._playStart=e._webAudio?t.ctx.currentTime:c._playStart),c._rate=i,e._webAudio&&c._node&&c._node.bufferSource?c._node.bufferSource.playbackRate.setValueAtTime(i,t.ctx.currentTime):c._node&&(c._node.playbackRate=i);var O=e.seek(l[g]),b=(e._sprite[c._sprite][0]+e._sprite[c._sprite][1])/1e3-O,P=b*1e3/Math.abs(c._rate);(e._endTimers[l[g]]||!c._paused)&&(e._clearTimer(l[g]),e._endTimers[l[g]]=setTimeout(e._ended.bind(e,c),P)),e._emit("rate",c._id)}}else return c=e._soundById(l),c?c._rate:e._rate;return e},seek:function(){var e=this,o=arguments,i,l;if(o.length===0)e._sounds.length&&(l=e._sounds[0]._id);else if(o.length===1){var d=e._getSoundIds(),f=d.indexOf(o[0]);f>=0?l=parseInt(o[0],10):e._sounds.length&&(l=e._sounds[0]._id,i=parseFloat(o[0]))}else o.length===2&&(i=parseFloat(o[0]),l=parseInt(o[1],10));if(typeof l>"u")return 0;if(typeof i=="number"&&(e._state!=="loaded"||e._playLock))return e._queue.push({event:"seek",action:function(){e.seek.apply(e,o)}}),e;var c=e._soundById(l);if(c)if(typeof i=="number"&&i>=0){var g=e.playing(l);g&&e.pause(l,!0),c._seek=i,c._ended=!1,e._clearTimer(l),!e._webAudio&&c._node&&!isNaN(c._node.duration)&&(c._node.currentTime=i);var O=function(){g&&e.play(l,!0),e._emit("seek",l)};if(g&&!e._webAudio){var b=function(){e._playLock?setTimeout(b,0):O()};setTimeout(b,0)}else O()}else if(e._webAudio){var P=e.playing(l)?t.ctx.currentTime-c._playStart:0,k=c._rateSeek?c._rateSeek-c._seek:0;return c._seek+(k+P*Math.abs(c._rate))}else return c._node.currentTime;return e},playing:function(e){var o=this;if(typeof e=="number"){var i=o._soundById(e);return i?!i._paused:!1}for(var l=0;l<o._sounds.length;l++)if(!o._sounds[l]._paused)return!0;return!1},duration:function(e){var o=this,i=o._duration,l=o._soundById(e);return l&&(i=o._sprite[l._sprite][1]/1e3),i},state:function(){return this._state},unload:function(){for(var e=this,o=e._sounds,i=0;i<o.length;i++)o[i]._paused||e.stop(o[i]._id),e._webAudio||(e._clearSound(o[i]._node),o[i]._node.removeEventListener("error",o[i]._errorFn,!1),o[i]._node.removeEventListener(t._canPlayEvent,o[i]._loadFn,!1),o[i]._node.removeEventListener("ended",o[i]._endFn,!1),t._releaseHtml5Audio(o[i]._node)),delete o[i]._node,e._clearTimer(o[i]._id);var l=t._howls.indexOf(e);l>=0&&t._howls.splice(l,1);var d=!0;for(i=0;i<t._howls.length;i++)if(t._howls[i]._src===e._src||e._src.indexOf(t._howls[i]._src)>=0){d=!1;break}return a&&d&&delete a[e._src],t.noAudio=!1,e._state="unloaded",e._sounds=[],e=null,null},on:function(e,o,i,l){var d=this,f=d["_on"+e];return typeof o=="function"&&f.push(l?{id:i,fn:o,once:l}:{id:i,fn:o}),d},off:function(e,o,i){var l=this,d=l["_on"+e],f=0;if(typeof o=="number"&&(i=o,o=null),o||i)for(f=0;f<d.length;f++){var c=i===d[f].id;if(o===d[f].fn&&c||!o&&c){d.splice(f,1);break}}else if(e)l["_on"+e]=[];else{var g=Object.keys(l);for(f=0;f<g.length;f++)g[f].indexOf("_on")===0&&Array.isArray(l[g[f]])&&(l[g[f]]=[])}return l},once:function(e,o,i){var l=this;return l.on(e,o,i,1),l},_emit:function(e,o,i){for(var l=this,d=l["_on"+e],f=d.length-1;f>=0;f--)(!d[f].id||d[f].id===o||e==="load")&&(setTimeout((function(c){c.call(this,o,i)}).bind(l,d[f].fn),0),d[f].once&&l.off(e,d[f].fn,d[f].id));return l._loadQueue(e),l},_loadQueue:function(e){var o=this;if(o._queue.length>0){var i=o._queue[0];i.event===e&&(o._queue.shift(),o._loadQueue()),e||i.action()}return o},_ended:function(e){var o=this,i=e._sprite;if(!o._webAudio&&e._node&&!e._node.paused&&!e._node.ended&&e._node.currentTime<e._stop)return setTimeout(o._ended.bind(o,e),100),o;var l=!!(e._loop||o._sprite[i][2]);if(o._emit("end",e._id),!o._webAudio&&l&&o.stop(e._id,!0).play(e._id),o._webAudio&&l){o._emit("play",e._id),e._seek=e._start||0,e._rateSeek=0,e._playStart=t.ctx.currentTime;var d=(e._stop-e._start)*1e3/Math.abs(e._rate);o._endTimers[e._id]=setTimeout(o._ended.bind(o,e),d)}return o._webAudio&&!l&&(e._paused=!0,e._ended=!0,e._seek=e._start||0,e._rateSeek=0,o._clearTimer(e._id),o._cleanBuffer(e._node),t._autoSuspend()),!o._webAudio&&!l&&o.stop(e._id,!0),o},_clearTimer:function(e){var o=this;if(o._endTimers[e]){if(typeof o._endTimers[e]!="function")clearTimeout(o._endTimers[e]);else{var i=o._soundById(e);i&&i._node&&i._node.removeEventListener("ended",o._endTimers[e],!1)}delete o._endTimers[e]}return o},_soundById:function(e){for(var o=this,i=0;i<o._sounds.length;i++)if(e===o._sounds[i]._id)return o._sounds[i];return null},_inactiveSound:function(){var e=this;e._drain();for(var o=0;o<e._sounds.length;o++)if(e._sounds[o]._ended)return e._sounds[o].reset();return new s(e)},_drain:function(){var e=this,o=e._pool,i=0,l=0;if(!(e._sounds.length<o)){for(l=0;l<e._sounds.length;l++)e._sounds[l]._ended&&i++;for(l=e._sounds.length-1;l>=0;l--){if(i<=o)return;e._sounds[l]._ended&&(e._webAudio&&e._sounds[l]._node&&e._sounds[l]._node.disconnect(0),e._sounds.splice(l,1),i--)}}},_getSoundIds:function(e){var o=this;if(typeof e>"u"){for(var i=[],l=0;l<o._sounds.length;l++)i.push(o._sounds[l]._id);return i}else return[e]},_refreshBuffer:function(e){var o=this;return e._node.bufferSource=t.ctx.createBufferSource(),e._node.bufferSource.buffer=a[o._src],e._panner?e._node.bufferSource.connect(e._panner):e._node.bufferSource.connect(e._node),e._node.bufferSource.loop=e._loop,e._loop&&(e._node.bufferSource.loopStart=e._start||0,e._node.bufferSource.loopEnd=e._stop||0),e._node.bufferSource.playbackRate.setValueAtTime(e._rate,t.ctx.currentTime),o},_cleanBuffer:function(e){var o=this,i=t._navigator&&t._navigator.vendor.indexOf("Apple")>=0;if(!e.bufferSource)return o;if(t._scratchBuffer&&e.bufferSource&&(e.bufferSource.onended=null,e.bufferSource.disconnect(0),i))try{e.bufferSource.buffer=t._scratchBuffer}catch{}return e.bufferSource=null,o},_clearSound:function(e){var o=/MSIE |Trident\//.test(t._navigator&&t._navigator.userAgent);o||(e.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var s=function(e){this._parent=e,this.init()};s.prototype={init:function(){var e=this,o=e._parent;return e._muted=o._muted,e._loop=o._loop,e._volume=o._volume,e._rate=o._rate,e._seek=0,e._paused=!0,e._ended=!0,e._sprite="__default",e._id=++t._counter,o._sounds.push(e),e.create(),e},create:function(){var e=this,o=e._parent,i=t._muted||e._muted||e._parent._muted?0:e._volume;return o._webAudio?(e._node=typeof t.ctx.createGain>"u"?t.ctx.createGainNode():t.ctx.createGain(),e._node.gain.setValueAtTime(i,t.ctx.currentTime),e._node.paused=!0,e._node.connect(t.masterGain)):t.noAudio||(e._node=t._obtainHtml5Audio(),e._errorFn=e._errorListener.bind(e),e._node.addEventListener("error",e._errorFn,!1),e._loadFn=e._loadListener.bind(e),e._node.addEventListener(t._canPlayEvent,e._loadFn,!1),e._endFn=e._endListener.bind(e),e._node.addEventListener("ended",e._endFn,!1),e._node.src=o._src,e._node.preload=o._preload===!0?"auto":o._preload,e._node.volume=i*t.volume(),e._node.load()),e},reset:function(){var e=this,o=e._parent;return e._muted=o._muted,e._loop=o._loop,e._volume=o._volume,e._rate=o._rate,e._seek=0,e._rateSeek=0,e._paused=!0,e._ended=!0,e._sprite="__default",e._id=++t._counter,e},_errorListener:function(){var e=this;e._parent._emit("loaderror",e._id,e._node.error?e._node.error.code:0),e._node.removeEventListener("error",e._errorFn,!1)},_loadListener:function(){var e=this,o=e._parent;o._duration=Math.ceil(e._node.duration*10)/10,Object.keys(o._sprite).length===0&&(o._sprite={__default:[0,o._duration*1e3]}),o._state!=="loaded"&&(o._state="loaded",o._emit("load"),o._loadQueue()),e._node.removeEventListener(t._canPlayEvent,e._loadFn,!1)},_endListener:function(){var e=this,o=e._parent;o._duration===1/0&&(o._duration=Math.ceil(e._node.duration*10)/10,o._sprite.__default[1]===1/0&&(o._sprite.__default[1]=o._duration*1e3),o._ended(e)),e._node.removeEventListener("ended",e._endFn,!1)}};var a={},u=function(e){var o=e._src;if(a[o]){e._duration=a[o].duration,_(e);return}if(/^data:[^;]+;base64,/.test(o)){for(var i=atob(o.split(",")[1]),l=new Uint8Array(i.length),d=0;d<i.length;++d)l[d]=i.charCodeAt(d);h(l.buffer,e)}else{var f=new XMLHttpRequest;f.open(e._xhr.method,o,!0),f.withCredentials=e._xhr.withCredentials,f.responseType="arraybuffer",e._xhr.headers&&Object.keys(e._xhr.headers).forEach(function(c){f.setRequestHeader(c,e._xhr.headers[c])}),f.onload=function(){var c=(f.status+"")[0];if(c!=="0"&&c!=="2"&&c!=="3"){e._emit("loaderror",null,"Failed loading audio file with status: "+f.status+".");return}h(f.response,e)},f.onerror=function(){e._webAudio&&(e._html5=!0,e._webAudio=!1,e._sounds=[],delete a[o],e.load())},y(f)}},y=function(e){try{e.send()}catch{e.onerror()}},h=function(e,o){var i=function(){o._emit("loaderror",null,"Decoding audio data failed.")},l=function(d){d&&o._sounds.length>0?(a[o._src]=d,_(o,d)):i()};typeof Promise<"u"&&t.ctx.decodeAudioData.length===1?t.ctx.decodeAudioData(e).then(l).catch(i):t.ctx.decodeAudioData(e,l,i)},_=function(e,o){o&&!e._duration&&(e._duration=o.duration),Object.keys(e._sprite).length===0&&(e._sprite={__default:[0,e._duration*1e3]}),e._state!=="loaded"&&(e._state="loaded",e._emit("load"),e._loadQueue())},v=function(){if(t.usingWebAudio){try{typeof AudioContext<"u"?t.ctx=new AudioContext:typeof webkitAudioContext<"u"?t.ctx=new webkitAudioContext:t.usingWebAudio=!1}catch{t.usingWebAudio=!1}t.ctx||(t.usingWebAudio=!1);var e=/iP(hone|od|ad)/.test(t._navigator&&t._navigator.platform),o=t._navigator&&t._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),i=o?parseInt(o[1],10):null;if(e&&i&&i<9){var l=/safari/.test(t._navigator&&t._navigator.userAgent.toLowerCase());t._navigator&&!l&&(t.usingWebAudio=!1)}t.usingWebAudio&&(t.masterGain=typeof t.ctx.createGain>"u"?t.ctx.createGainNode():t.ctx.createGain(),t.masterGain.gain.setValueAtTime(t._muted?0:t._volume,t.ctx.currentTime),t.masterGain.connect(t.ctx.destination)),t._setup()}};p.Howler=t,p.Howl=r,typeof q<"u"?(q.HowlerGlobal=n,q.Howler=t,q.Howl=r,q.Sound=s):typeof window<"u"&&(window.HowlerGlobal=n,window.Howler=t,window.Howl=r,window.Sound=s)})();/*!
 *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
 *  
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(){HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(t){var r=this;if(!r.ctx||!r.ctx.listener)return r;for(var s=r._howls.length-1;s>=0;s--)r._howls[s].stereo(t);return r},HowlerGlobal.prototype.pos=function(t,r,s){var a=this;if(!a.ctx||!a.ctx.listener)return a;if(r=typeof r!="number"?a._pos[1]:r,s=typeof s!="number"?a._pos[2]:s,typeof t=="number")a._pos=[t,r,s],typeof a.ctx.listener.positionX<"u"?(a.ctx.listener.positionX.setTargetAtTime(a._pos[0],Howler.ctx.currentTime,.1),a.ctx.listener.positionY.setTargetAtTime(a._pos[1],Howler.ctx.currentTime,.1),a.ctx.listener.positionZ.setTargetAtTime(a._pos[2],Howler.ctx.currentTime,.1)):a.ctx.listener.setPosition(a._pos[0],a._pos[1],a._pos[2]);else return a._pos;return a},HowlerGlobal.prototype.orientation=function(t,r,s,a,u,y){var h=this;if(!h.ctx||!h.ctx.listener)return h;var _=h._orientation;if(r=typeof r!="number"?_[1]:r,s=typeof s!="number"?_[2]:s,a=typeof a!="number"?_[3]:a,u=typeof u!="number"?_[4]:u,y=typeof y!="number"?_[5]:y,typeof t=="number")h._orientation=[t,r,s,a,u,y],typeof h.ctx.listener.forwardX<"u"?(h.ctx.listener.forwardX.setTargetAtTime(t,Howler.ctx.currentTime,.1),h.ctx.listener.forwardY.setTargetAtTime(r,Howler.ctx.currentTime,.1),h.ctx.listener.forwardZ.setTargetAtTime(s,Howler.ctx.currentTime,.1),h.ctx.listener.upX.setTargetAtTime(a,Howler.ctx.currentTime,.1),h.ctx.listener.upY.setTargetAtTime(u,Howler.ctx.currentTime,.1),h.ctx.listener.upZ.setTargetAtTime(y,Howler.ctx.currentTime,.1)):h.ctx.listener.setOrientation(t,r,s,a,u,y);else return _;return h},Howl.prototype.init=function(t){return function(r){var s=this;return s._orientation=r.orientation||[1,0,0],s._stereo=r.stereo||null,s._pos=r.pos||null,s._pannerAttr={coneInnerAngle:typeof r.coneInnerAngle<"u"?r.coneInnerAngle:360,coneOuterAngle:typeof r.coneOuterAngle<"u"?r.coneOuterAngle:360,coneOuterGain:typeof r.coneOuterGain<"u"?r.coneOuterGain:0,distanceModel:typeof r.distanceModel<"u"?r.distanceModel:"inverse",maxDistance:typeof r.maxDistance<"u"?r.maxDistance:1e4,panningModel:typeof r.panningModel<"u"?r.panningModel:"HRTF",refDistance:typeof r.refDistance<"u"?r.refDistance:1,rolloffFactor:typeof r.rolloffFactor<"u"?r.rolloffFactor:1},s._onstereo=r.onstereo?[{fn:r.onstereo}]:[],s._onpos=r.onpos?[{fn:r.onpos}]:[],s._onorientation=r.onorientation?[{fn:r.onorientation}]:[],t.call(this,r)}}(Howl.prototype.init),Howl.prototype.stereo=function(t,r){var s=this;if(!s._webAudio)return s;if(s._state!=="loaded")return s._queue.push({event:"stereo",action:function(){s.stereo(t,r)}}),s;var a=typeof Howler.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof r>"u")if(typeof t=="number")s._stereo=t,s._pos=[t,0,0];else return s._stereo;for(var u=s._getSoundIds(r),y=0;y<u.length;y++){var h=s._soundById(u[y]);if(h)if(typeof t=="number")h._stereo=t,h._pos=[t,0,0],h._node&&(h._pannerAttr.panningModel="equalpower",(!h._panner||!h._panner.pan)&&n(h,a),a==="spatial"?typeof h._panner.positionX<"u"?(h._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),h._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),h._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):h._panner.setPosition(t,0,0):h._panner.pan.setValueAtTime(t,Howler.ctx.currentTime)),s._emit("stereo",h._id);else return h._stereo}return s},Howl.prototype.pos=function(t,r,s,a){var u=this;if(!u._webAudio)return u;if(u._state!=="loaded")return u._queue.push({event:"pos",action:function(){u.pos(t,r,s,a)}}),u;if(r=typeof r!="number"?0:r,s=typeof s!="number"?-.5:s,typeof a>"u")if(typeof t=="number")u._pos=[t,r,s];else return u._pos;for(var y=u._getSoundIds(a),h=0;h<y.length;h++){var _=u._soundById(y[h]);if(_)if(typeof t=="number")_._pos=[t,r,s],_._node&&((!_._panner||_._panner.pan)&&n(_,"spatial"),typeof _._panner.positionX<"u"?(_._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),_._panner.positionY.setValueAtTime(r,Howler.ctx.currentTime),_._panner.positionZ.setValueAtTime(s,Howler.ctx.currentTime)):_._panner.setPosition(t,r,s)),u._emit("pos",_._id);else return _._pos}return u},Howl.prototype.orientation=function(t,r,s,a){var u=this;if(!u._webAudio)return u;if(u._state!=="loaded")return u._queue.push({event:"orientation",action:function(){u.orientation(t,r,s,a)}}),u;if(r=typeof r!="number"?u._orientation[1]:r,s=typeof s!="number"?u._orientation[2]:s,typeof a>"u")if(typeof t=="number")u._orientation=[t,r,s];else return u._orientation;for(var y=u._getSoundIds(a),h=0;h<y.length;h++){var _=u._soundById(y[h]);if(_)if(typeof t=="number")_._orientation=[t,r,s],_._node&&(_._panner||(_._pos||(_._pos=u._pos||[0,0,-.5]),n(_,"spatial")),typeof _._panner.orientationX<"u"?(_._panner.orientationX.setValueAtTime(t,Howler.ctx.currentTime),_._panner.orientationY.setValueAtTime(r,Howler.ctx.currentTime),_._panner.orientationZ.setValueAtTime(s,Howler.ctx.currentTime)):_._panner.setOrientation(t,r,s)),u._emit("orientation",_._id);else return _._orientation}return u},Howl.prototype.pannerAttr=function(){var t=this,r=arguments,s,a,u;if(!t._webAudio)return t;if(r.length===0)return t._pannerAttr;if(r.length===1)if(typeof r[0]=="object")s=r[0],typeof a>"u"&&(s.pannerAttr||(s.pannerAttr={coneInnerAngle:s.coneInnerAngle,coneOuterAngle:s.coneOuterAngle,coneOuterGain:s.coneOuterGain,distanceModel:s.distanceModel,maxDistance:s.maxDistance,refDistance:s.refDistance,rolloffFactor:s.rolloffFactor,panningModel:s.panningModel}),t._pannerAttr={coneInnerAngle:typeof s.pannerAttr.coneInnerAngle<"u"?s.pannerAttr.coneInnerAngle:t._coneInnerAngle,coneOuterAngle:typeof s.pannerAttr.coneOuterAngle<"u"?s.pannerAttr.coneOuterAngle:t._coneOuterAngle,coneOuterGain:typeof s.pannerAttr.coneOuterGain<"u"?s.pannerAttr.coneOuterGain:t._coneOuterGain,distanceModel:typeof s.pannerAttr.distanceModel<"u"?s.pannerAttr.distanceModel:t._distanceModel,maxDistance:typeof s.pannerAttr.maxDistance<"u"?s.pannerAttr.maxDistance:t._maxDistance,refDistance:typeof s.pannerAttr.refDistance<"u"?s.pannerAttr.refDistance:t._refDistance,rolloffFactor:typeof s.pannerAttr.rolloffFactor<"u"?s.pannerAttr.rolloffFactor:t._rolloffFactor,panningModel:typeof s.pannerAttr.panningModel<"u"?s.pannerAttr.panningModel:t._panningModel});else return u=t._soundById(parseInt(r[0],10)),u?u._pannerAttr:t._pannerAttr;else r.length===2&&(s=r[0],a=parseInt(r[1],10));for(var y=t._getSoundIds(a),h=0;h<y.length;h++)if(u=t._soundById(y[h]),u){var _=u._pannerAttr;_={coneInnerAngle:typeof s.coneInnerAngle<"u"?s.coneInnerAngle:_.coneInnerAngle,coneOuterAngle:typeof s.coneOuterAngle<"u"?s.coneOuterAngle:_.coneOuterAngle,coneOuterGain:typeof s.coneOuterGain<"u"?s.coneOuterGain:_.coneOuterGain,distanceModel:typeof s.distanceModel<"u"?s.distanceModel:_.distanceModel,maxDistance:typeof s.maxDistance<"u"?s.maxDistance:_.maxDistance,refDistance:typeof s.refDistance<"u"?s.refDistance:_.refDistance,rolloffFactor:typeof s.rolloffFactor<"u"?s.rolloffFactor:_.rolloffFactor,panningModel:typeof s.panningModel<"u"?s.panningModel:_.panningModel};var v=u._panner;v||(u._pos||(u._pos=t._pos||[0,0,-.5]),n(u,"spatial"),v=u._panner),v.coneInnerAngle=_.coneInnerAngle,v.coneOuterAngle=_.coneOuterAngle,v.coneOuterGain=_.coneOuterGain,v.distanceModel=_.distanceModel,v.maxDistance=_.maxDistance,v.refDistance=_.refDistance,v.rolloffFactor=_.rolloffFactor,v.panningModel=_.panningModel}return t},Sound.prototype.init=function(t){return function(){var r=this,s=r._parent;r._orientation=s._orientation,r._stereo=s._stereo,r._pos=s._pos,r._pannerAttr=s._pannerAttr,t.call(this),r._stereo?s.stereo(r._stereo):r._pos&&s.pos(r._pos[0],r._pos[1],r._pos[2],r._id)}}(Sound.prototype.init),Sound.prototype.reset=function(t){return function(){var r=this,s=r._parent;return r._orientation=s._orientation,r._stereo=s._stereo,r._pos=s._pos,r._pannerAttr=s._pannerAttr,r._stereo?s.stereo(r._stereo):r._pos?s.pos(r._pos[0],r._pos[1],r._pos[2],r._id):r._panner&&(r._panner.disconnect(0),r._panner=void 0,s._refreshBuffer(r)),t.call(this)}}(Sound.prototype.reset);var n=function(t,r){r=r||"spatial",r==="spatial"?(t._panner=Howler.ctx.createPanner(),t._panner.coneInnerAngle=t._pannerAttr.coneInnerAngle,t._panner.coneOuterAngle=t._pannerAttr.coneOuterAngle,t._panner.coneOuterGain=t._pannerAttr.coneOuterGain,t._panner.distanceModel=t._pannerAttr.distanceModel,t._panner.maxDistance=t._pannerAttr.maxDistance,t._panner.refDistance=t._pannerAttr.refDistance,t._panner.rolloffFactor=t._pannerAttr.rolloffFactor,t._panner.panningModel=t._pannerAttr.panningModel,typeof t._panner.positionX<"u"?(t._panner.positionX.setValueAtTime(t._pos[0],Howler.ctx.currentTime),t._panner.positionY.setValueAtTime(t._pos[1],Howler.ctx.currentTime),t._panner.positionZ.setValueAtTime(t._pos[2],Howler.ctx.currentTime)):t._panner.setPosition(t._pos[0],t._pos[1],t._pos[2]),typeof t._panner.orientationX<"u"?(t._panner.orientationX.setValueAtTime(t._orientation[0],Howler.ctx.currentTime),t._panner.orientationY.setValueAtTime(t._orientation[1],Howler.ctx.currentTime),t._panner.orientationZ.setValueAtTime(t._orientation[2],Howler.ctx.currentTime)):t._panner.setOrientation(t._orientation[0],t._orientation[1],t._orientation[2])):(t._panner=Howler.ctx.createStereoPanner(),t._panner.pan.setValueAtTime(t._stereo,Howler.ctx.currentTime)),t._panner.connect(t._node),t._paused||t._parent.pause(t._id,!0).play(t._id,!0)}})()})(he);const M={STEP:"STEP",PULSE:"PULSE",BOX:"BOX",SPARKLE:"SPARKLE"},ze={[M.STEP]:{prefix:"step",number:4},[M.PULSE]:{prefix:"pulse",number:1},[M.BOX]:{prefix:"box",number:1},[M.SPARKLE]:{prefix:"sparkle",number:1}};var J;let j=(J=class{static init(){this.initialized=!0,Object.keys(ze).forEach(n=>{const t=ze[n],r=[];this.sounds.set(n,r);for(let s=0;s<t.number;s++){const a=this.getPath(t.prefix+(s+1)+".wav");r.push(new he.Howl({src:a}))}})}static getPath(n){return"assets/"+n}static playTheme(){this.theme==null&&(this.theme=new he.Howl({src:this.getPath("theme.wav"),loop:!0}),this.theme.once("load",()=>{var n;return(n=this.theme)==null?void 0:n.play()}))}static play(n){this.initialized||this.init(),console.log("playing fucking sound: "+n);const t=this.sounds.get(n),r=Math.floor(Math.random()*t.length);t[r].play()}},m(J,"initialized",!1),m(J,"sounds",new Map),m(J,"theme",null),J);const I={MOVE:"MOVE",FIRE:"FIRE",UNDO:"UNDO",RESET:"RESET",NEXT:"NEXT",ACTION_1:"ACTION_1",ACTION_2:"ACTION_2"},N={PLAY:"PLAY",GAMEOVER:"GAMEOVER",WIN:"WIN"};class ue{constructor(n,t){m(this,"mode","PLAY");m(this,"puzzle",new G);m(this,"renderList",[]);m(this,"entityAtPoint",null);m(this,"inputQueue",[]);m(this,"transitions",[]);m(this,"history",[]);m(this,"textEntities",[]);m(this,"computeEntityAtPoint",(n,t)=>{const r=Ne(this.g.canvas,this.getOffset(),this.renderList,n,t);return K.byId.get(r)||null});m(this,"onExit",()=>{this.removeCallbacks()});m(this,"onKeyDown",n=>{switch(n.key){case" ":this.puzzle.didPlayerWin()&&this.inputQueue.push({type:I.NEXT});break;case"]":this.puzzle.rotateRight(!1),this.computeTransitionsAll(),n.preventDefault(),n.stopPropagation();break;case"[":this.puzzle.rotateLeft(!1),this.computeTransitionsAll(),n.preventDefault(),n.stopPropagation();break;case"ArrowUp":case"w":this.inputQueue.push({type:I.MOVE,dir:L.forward}),n.stopPropagation();break;case"ArrowDown":case"s":this.inputQueue.push({type:I.MOVE,dir:L.back}),n.stopPropagation();break;case"ArrowLeft":case"a":this.inputQueue.push({type:I.MOVE,dir:L.left}),n.stopPropagation();break;case"ArrowRight":case"d":this.inputQueue.push({type:I.MOVE,dir:L.right}),n.stopPropagation();break;case"z":this.inputQueue.push({type:I.UNDO}),n.stopPropagation();break;case"r":this.inputQueue.push({type:I.RESET}),n.stopPropagation();break;case"F10":this.puzzle.reset(),this.puzzle.history.length=0,this.g.popScreen(),this.g.pushScreen(new Ct(this.g,this.puzzle));break;case"i":this.inputQueue.push({type:I.FIRE,dir:L.forward});break;case"j":this.inputQueue.push({type:I.FIRE,dir:L.left});break;case"k":this.inputQueue.push({type:I.FIRE,dir:L.back});break;case"l":this.inputQueue.push({type:I.FIRE,dir:L.right});break}});m(this,"onMouseMove",n=>{});m(this,"onMouseDown",n=>{});m(this,"onContextMenu",n=>(n.preventDefault(),!1));this.g=n,this.puzzle=t,console.log(this.puzzle),this.init()}update(){switch(this.mode){case N.PLAY:this.processTransitions(),this.transitions.length===0&&this.puzzle.tick()&&this.computeTransitions(),this.updateAnimations(),this.handleInput(),this.checkGameOver();break;case N.GAMEOVER:this.processTransitions(),this.transitions.length===0&&this.puzzle.tick(),this.updateAnimations(),this.handleInput();break;case N.WIN:this.processTransitions(),this.updateAnimations(),this.handleInput();break}}loadNextPuzzle(){this.g.popScreen();const n=X.loadPuzzleByName(this.puzzle.next);n===null||this.g.pushScreen(new ue(this.g,n))}checkGameOver(){this.puzzle.didPlayerLose()?(this.mode=N.GAMEOVER,this.showText(`
            you died :(<br>
            press z to undo<br>
            press r to restart
            `)):this.puzzle.didPlayerWin()&&(this.mode=N.WIN,j.play(M.SPARKLE),this.showText("frotz!<br>press space<br>to continue"))}clearText(){this.textEntities.length=0}showText(n){this.textEntities.length=0;const t=n.trim().split("<br>");for(let r=0;r<t.length;r++)this.showText1(t[r].trim().toLowerCase(),t.length-1-r)}showText1(n,t=0){console.log(n);const r=oe.a.width*R,s=oe.a.height*R,a=n.length/2*r,u=this.getOffset();let h=T.create(u.x-a*r,u.y-u.y/2-t*s,0);for(let _=0;_<n.length;_++){const v=T.create(u.x-a+r*_,h.y,0),e=Math.random()*Math.PI*2,o=v.x+Math.cos(e)*r*10,i=v.y+Math.sin(e)*r*10,l=L.create(o,i,0),d=T.create(l.x,l.y,0),f={pos:T.create(h.x,h.y,h.z),screenPos:T.create(l.x,l.y,l.z),lastPos:l,sprite:oe[n[_]]},c={e:f,start:d,end:v,elapsed:0,duration:600,bounce:!1};this.textEntities.push(f),this.transitions.push(c)}}handleInput(){if(this.inputQueue.length===0)return;const n=this.inputQueue.shift();switch(n.type){case I.NEXT:this.loadNextPuzzle();break;case I.MOVE:if(this.puzzle.isGameOver())return;if(this.transitions.length>0){this.inputQueue.unshift(n);return}this.puzzle.movePlayer(n.dir),this.computeTransitions();break;case I.FIRE:const t=L.add(this.puzzle.player.pos,n.dir);if(this.puzzle.isGameOver())return;if(this.transitions.length>0){this.inputQueue.unshift(n);return}if(this.puzzle.v2e.get(t)!=null)return;const r=this.puzzle.createEntity(E.PULSE,t);r.momentum=n.dir,this.renderList.push(r),this.computeTransitions();break;case I.UNDO:this.puzzle.undo(),this.transitions.length=0,this.clearText(),this.resetScreenPositions(),this.mode=N.PLAY;break;case I.RESET:this.puzzle.reset(),this.transitions.length=0,this.clearText(),this.resetScreenPositions(),this.mode=N.PLAY;break}}computeTransitionsAll(){for(const n of this.puzzle.v2e.values())if(n.pos!=n.lastPos){const t=this.computeTransition1(n);t!=null&&this.transitions.push(t)}}computeTransitions(){for(const n of this.puzzle.actors)if(n.pos!==n.lastPos){const t=this.computeTransition1(n);t!=null&&this.transitions.push(t)}}computeTransition1(n){return n.lastPos=n.pos,n.type===E.WIZARD?{e:n,start:n.screenPos,end:n.pos,duration:200,elapsed:0,bounce:!0}:n.type===E.PULSE?{e:n,start:n.screenPos,end:n.pos,duration:50,elapsed:0,bounce:!0}:{e:n,start:n.screenPos,end:n.pos,duration:200,elapsed:0,bounce:!1}}processTransitions(){const n=new Set;for(const t of this.transitions){if(t.elapsed===0&&t.sprite){const s=t.e;s.frames=t.sprite.frames,s.frameDuration=t.sprite.duration,s.playbackMode=t.sprite.mode||"LOOP"}const r=t.e;t.elapsed===0&&r.type&&(r.type===E.WIZARD&&L.sub(t.end,t.start).z===0&&j.play(M.STEP),r.type===E.BOX&&L.sub(t.end,t.start).z===0&&j.play(M.BOX),r.type===E.PULSE&&r.age===1&&j.play(M.PULSE)),t.elapsed+=this.g.dt,this.processTransition1(t),t.elapsed>=t.duration&&n.add(t)}for(let t=this.transitions.length-1;t>=0;t--){const r=this.transitions[t];n.has(r)&&this.transitions.splice(t,1)}}processTransition1(n){if(n.duration===0)return;const t=n.elapsed/n.duration,r=T.mul(T.sub(n.end,n.start),t);let s=0;if(n.bounce&&(s=t<.5?t*be:(1-t)*be),t>=1){if(n.e.screenPos=n.end,n.e.destroyed){this.puzzle.v2e.delete(n.e.pos);const a=this.renderList.indexOf(n.e);a!=-1&&this.renderList.splice(a,1)}}else r.z+=s,n.e.screenPos=T.add(n.start,r)}resetScreenPositions(){for(const n of this.puzzle.actors)n.screenPos=T.create(n.pos.x,n.pos.y,n.pos.z)}init(){this.g.canvas.focus(),this.addCallbacks();for(const n of this.puzzle.v2e.values())this.renderList.push(n);this.puzzle.hint&&this.showText(this.puzzle.hint),j.playTheme()}addCallbacks(){this.g.canvas.addEventListener("mousemove",this.onMouseMove),this.g.canvas.addEventListener("mousedown",this.onMouseDown),this.g.canvas.addEventListener("keydown",this.onKeyDown),this.g.canvas.oncontextmenu=this.onContextMenu}removeCallbacks(){this.g.canvas.removeEventListener("mousemove",this.onMouseMove),this.g.canvas.removeEventListener("mousedown",this.onMouseDown),this.g.canvas.removeEventListener("keydown",this.onKeyDown),this.g.canvas.oncontextmenu=null}updateAnimations(){const{dt:n}=this.g;for(const t of this.puzzle.v2e.values())t.frameDuration!==0&&(t.frameElapsed+=n,t.frameElapsed>=t.frameDuration&&(t.playbackMode===ye.LOOP?(t.frameElapsed=t.frameElapsed%t.frameDuration,t.frameIndex=(t.frameIndex+1)%t.frames.length):t.frameIndex=t.frames.length-1))}render(){const{canvas:n}=this.g;n.getContext("2d").clearRect(0,0,n.width,n.height),this.renderEntities(),this.renderHighlight(),this.renderText()}renderText(){this.textEntities.forEach(n=>{mt(this.g.canvas,n.sprite,n.screenPos.x,n.screenPos.y)})}sortRenderList(){this.renderList.sort((n,t)=>{const r=n.screenPos.x+n.screenPos.y,s=t.screenPos.x+t.screenPos.y;return r<s?-1:s<r?1:n.pos.z<t.pos.z?-1:t.pos.z<n.pos.z?1:0})}renderEntities(){this.sortRenderList(),ve(this.g.canvas,this.getOffset(),this.renderList)}renderHighlight(){this.entityAtPoint!==null&&He(this.g.canvas,this.getOffset(),this.entityAtPoint,A.highlight[0])}getOffset(){return T.create(this.g.canvas.width/2,this.g.canvas.height/2,0)}tick(){this.update(),this.render()}}ut(()=>{const p=new ft;{p.pushScreen(new ue(p,X.loadPuzzleByName("1"))),p.start();return}});
